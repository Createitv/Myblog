<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1"><meta name="robots" content="noodp"/><title>基于线程的并行 | 且慢</title><meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content=""/>
<meta name="twitter:title" content="基于线程的并行"/>
<meta name="twitter:description" content="Createitv"/><meta name="Description" content="Createitv"><meta property="og:title" content="基于线程的并行" />
<meta property="og:description" content="Createitv" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://www.longtermbook.com/posts/%E5%9F%BA%E4%BA%8E%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%B9%B6%E8%A1%8C/" /><meta property="og:image" content="http://www.longtermbook.com/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-27T11:06:07&#43;08:00" />
<meta property="article:modified_time" content="2021-07-27T11:06:07&#43;08:00" /><meta property="og:site_name" content="且慢" />

<meta name="application-name" content="Createitv">
<meta name="apple-mobile-web-app-title" content="Createitv"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
        <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
        <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://www.longtermbook.com/posts/%E5%9F%BA%E4%BA%8E%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%B9%B6%E8%A1%8C/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "基于线程的并行",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/www.longtermbook.com\/posts\/%E5%9F%BA%E4%BA%8E%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%B9%B6%E8%A1%8C\/"
        },"genre": "posts","keywords": "python高性能编程","wordCount":  8482 ,
        "url": "http:\/\/www.longtermbook.com\/posts\/%E5%9F%BA%E4%BA%8E%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%B9%B6%E8%A1%8C\/","datePublished": "2021-07-27T11:06:07+08:00","dateModified": "2021-07-27T11:06:07+08:00","description": "Createitv"
    }
    </script><script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [{
            "@type": "ListItem",
            "position": 1,
            "name": "主页",
            "item": "http:\/\/www.longtermbook.com\/"
        },{
            "@type": "ListItem",
            "position": 2,
            "name": "python",
            "item": "http://www.longtermbook.com/categories/python/"
        },{
                "@type": "ListItem",
                "position": 3,
                "name": "基于线程的并行"
            }]
    }
</script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="且慢" class="header-logo logo-svg">且慢</a>
        </div>
        <div class="menu">
            <nav>
                <ul class="menu-inner"><li>
                        <a class="menu-item" href="/posts/"> 文章 </a>
                    </li><li>
                        <a class="menu-item" href="/tags/"> 标签 </a>
                    </li><li>
                        <a class="menu-item" href="/categories/"> 分类 </a>
                    </li></ul>
            </nav><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <span class="svg-icon icon-search"></span>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <span class="svg-icon icon-cancel"></span>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <span class="svg-icon icon-loading"></span>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <span class="svg-icon icon-moon"></span>
                </a>
            </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="且慢" class="header-logo">且慢</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <span class="svg-icon icon-search"></span>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <span class="svg-icon icon-cancel"></span>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <span class="svg-icon icon-loading"></span>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><nav>
                <ul><li>
                        <a class="menu-item" href="/posts/" title="">文章</a>
                    </li><li>
                        <a class="menu-item" href="/tags/" title="">标签</a>
                    </li><li>
                        <a class="menu-item" href="/categories/" title="">分类</a>
                    </li></ul>
            </nav>
            <a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <span class="svg-icon icon-moon"></span>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div><main class="main">
<div class="container content-article  theme-classic"><div class="toc" id="toc-auto">
            <div class="toc-title">目录</div>
            <div class="toc-content" id="toc-content-auto"></div>
        </div>

    <div class="header-post">

        

        
        <div class="post-title">

                <div class="post-all-meta">
                    <nav class="breadcrumbs">
    <ol>
        <li><a href="/">主页 </a></li><li><a href="/categories/python/">python </a></li><li>基于线程的并行</li>
    </ol>
</nav>
                    <h1 class="single-title flipInX">基于线程的并行</h1><div class="post-meta">
                        <div class="post-meta-line"><span class="post-category">
                                <a href="/categories/python/"><i class="svg-icon icon-folder"></i>python</a>
                            </span><span class="post-meta-date">
                                <i class="svg-icon icon-clock"></i><time class="timeago" datetime="2021-07-27">2021-07-27</time>
                            </span><span class="post-meta-words">
                                <i class="svg-icon icon-pencil"></i>约 8482 字
                            </span>
                            <span class="post-meta-reading">
                                <i class="svg-icon icon-stopwatch"></i>预计阅读 17 分钟
                            </span>
                        </div>
                    </div>
                </div>

            </div>

            </div>

    <article class="single toc-start">

        <div class="content-block content-block-first content-block-position">

        <div class="post"><div class="details toc" id="toc-static"  data-kept="true">
                <div class="details-summary toc-title">
                    <span>目录</span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-线程介绍">1. 线程介绍</a></li>
    <li><a href="#2-python线程模块介绍">2. python线程模块介绍</a></li>
    <li><a href="#3-定义一个python线程">3. 定义一个python线程</a>
      <ul>
        <li><a href="#31-代码举例">3.1 代码举例</a></li>
      </ul>
    </li>
    <li><a href="#4-确定线程运行状态">4. 确定线程运行状态</a>
      <ul>
        <li><a href="#给线程命名">给线程命名</a></li>
        <li><a href="#解析">解析</a></li>
      </ul>
    </li>
    <li><a href="#5-自己动手实现一个线程">5. 自己动手实现一个线程</a></li>
    <li><a href="#6-线程锁">6. 线程锁🔒</a>
      <ul>
        <li><a href="#61-代码解释">6.1 代码解释</a></li>
        <li><a href="#62-代码解释">6.2 代码解释</a></li>
        <li><a href="#63-线程弊端">6.3. 线程弊端</a></li>
      </ul>
    </li>
    <li><a href="#7-递归锁rlock">7. 递归锁RLOCK</a></li>
    <li><a href="#8-信号量">8. 信号量</a>
      <ul>
        <li><a href="#81-代码">8.1 代码</a></li>
        <li><a href="#82-消费者模型的信号量使用">8.2 消费者模型的信号量使用</a></li>
      </ul>
    </li>
    <li><a href="#9-条件线程设置">9. 条件线程设置</a>
      <ul>
        <li><a href="#91-代码">9.1 代码</a></li>
      </ul>
    </li>
    <li><a href="#10-事件进行线程同步">10. 事件进行线程同步</a>
      <ul>
        <li><a href="#101-代码">10.1 代码</a></li>
      </ul>
    </li>
    <li><a href="#11-线程中的with语句">11. 线程中的with语句</a>
      <ul>
        <li><a href="#111-代码">11.1 代码</a></li>
        <li><a href="#102-解释">10.2 解释</a></li>
      </ul>
    </li>
    <li><a href="#12-使用队列进行线程通信">12. 使用队列进行线程通信</a>
      <ul>
        <li><a href="#122-代码">12.2 代码</a></li>
        <li><a href="#122-解释">12.2 解释</a></li>
      </ul>
    </li>
    <li><a href="#13-评估多线程应用的性能">13. 评估多线程应用的性能</a>
      <ul>
        <li><a href="#131-代码">13.1 代码</a></li>
      </ul>
    </li>
    <li><a href="#132-解释">13.2. 解释</a>
      <ul>
        <li><a href="#第一次测试">第一次测试</a></li>
        <li><a href="#第二次测试">第二次测试</a></li>
        <li><a href="#第三次测试">第三次测试</a></li>
        <li><a href="#第四次测试">第四次测试</a></li>
      </ul>
    </li>
    <li><a href="#133-了解更多">13.3. 了解更多</a></li>
  </ul>
</nav></div>
            </div><h2 id="1-线程介绍">1. 线程介绍</h2>
<p>目前，在软件应用中使用最广泛的并发编程范例是多线程。通常，一个应用有一个进程，分成多个独立的线程，并行运行、互相配合，执行不同类型的任务。</p>
<p>主要特点：</p>
<ul>
<li>线程是独立的处理流程，可以和系统的其他线程并行或并发地执行。</li>
<li>多线程可以共享数据和资源，利用所谓的共享内存空间。</li>
<li>同一进程的多个不同的线程可以共享相同的资源。相比而言，进程之间不会共享资源。</li>
</ul>
<p>每一个线程基本上包含3个元素：程序计数器，寄存器和栈。与同一进程的其他线程共享的资源基本上包括数据和系统资源。每一个线程也有自己的运行状态，可以和其他线程同步，这点和进程一样。线程的状态大体上可以分为<strong>ready</strong>,<strong>running</strong>,<strong>blocked</strong>。</p>
<h2 id="2-python线程模块介绍">2. python线程模块介绍</h2>
<p>Python通过标准库的 <code>threading</code> 模块来管理线程。这个模块提供了很多不错的特性，让线程变得无比简单。实际上，线程模块提供了几种同时运行的机制，实现起来非常简单。</p>
<p>线程模块的主要组件如下：</p>
<ul>
<li>线程对象</li>
<li>Lock对象</li>
<li>RLock对象</li>
<li>信号对象</li>
<li>条件对象</li>
<li>事件对象</li>
</ul>
<h2 id="3-定义一个python线程">3. 定义一个python线程</h2>
<p>使用线程最简单的一个方法是，用一个目标函数实例化一个Thread然后调用 <code>start()</code> 方法启动它。Python的threading模块提供了 <code>Thread()</code> 方法在不同的线程中运行函数或处理过程等。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                       <span class="n">target</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                       <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                       <span class="n">args</span><span class="o">=</span><span class="p">(),</span>
                       <span class="n">kwargs</span><span class="o">=</span><span class="p">{})</span>
</code></pre></td></tr></table>
</div>
</div><p>上面的代码中：</p>
<ul>
<li><code>group</code>: 一般设置为 <code>None</code> ，这是为以后的一些特性预留的</li>
<li><code>target</code>: 当线程启动的时候要执行的函数</li>
<li><code>name</code>: 线程的名字，默认会分配一个唯一名字 <code>Thread-N</code></li>
<li><code>args</code>: 传递给 <code>target</code> 的参数，要使用tuple类型</li>
<li><code>kwargs</code>: 同上，使用字典类型dict</li>
</ul>
<p>创建线程的方法非常实用，通过<code>target</code>参数<code>arg</code>和<code>kwarg</code>告诉线程应该做什么。下面这个例子传递一个数字给线程（这个数字正好等于线程号码），目标函数会打印出这个数字。</p>
<h3 id="31-代码举例">3.1 代码举例</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">threading</span>

<span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="k">print</span> <span class="p">(</span><span class="s2">&#34;function called by thread </span><span class="si">%i</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">return</span>

<span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
  	<span class="c1"># 线程对象</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">function</span> <span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="c1"># 加入主线程队列</span>
    <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>输出</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"> <span class="err">✔</span>  <span class="n">python</span> <span class="o">-</span><span class="n">u</span> <span class="n">thread_simple</span><span class="o">.</span><span class="n">py</span>
<span class="n">function</span> <span class="n">called</span> <span class="n">by</span> <span class="n">thread</span> <span class="mi">0</span>

<span class="n">function</span> <span class="n">called</span> <span class="n">by</span> <span class="n">thread</span> <span class="mi">1</span>

<span class="n">function</span> <span class="n">called</span> <span class="n">by</span> <span class="n">thread</span> <span class="mi">2</span>

<span class="n">function</span> <span class="n">called</span> <span class="n">by</span> <span class="n">thread</span> <span class="mi">3</span>

<span class="n">function</span> <span class="n">called</span> <span class="n">by</span> <span class="n">thread</span> <span class="mi">4</span>
</code></pre></td></tr></table>
</div>
</div><p>导入内置threading模块，简单地使用python命令就可以了：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">import threading
</code></pre></td></tr></table>
</div>
</div><p>在主程序中，我们使用目标函数 <code>function</code> 初始化了一个线程对象 <code>Thread</code> 。同时还传入了用于打印的一个参数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">t = threading.Thread(target=function , args=(i, ))
</code></pre></td></tr></table>
</div>
</div><p>线程被创建之后并不会马上运行，需要手动调用 <code>start()</code> ， <code>join()</code> 让调用它的线程一直等待直到执行结束（即阻塞调用它的主线程， <code>t</code> 线程执行结束，主线程才会继续执行）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">t.start()
t.join()
</code></pre></td></tr></table>
</div>
</div><h2 id="4-确定线程运行状态">4. 确定线程运行状态</h2>
<p>threading模块提供了一些比较实用的方法或者属性</p>
<p>




<img loading="lazy" decoding="async"
         src="https://typora-1300715298.cos.ap-shanghai.myqcloud.com/uPic/image-20210624092547213.png"
         alt="image-20210624092547213"
         title="image-20210624092547213.png"
    /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                    <span class="n">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1">-</span><span class="si">%(levelname)s</span><span class="s1">-</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">sites</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;&lt;https://www.yahoo.com/&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;http://www.cnn.com&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;http://www.python.org&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;http://www.jython.org&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;http://www.pypy.org&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;http://www.perl.org&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;http://www.cisco.com&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;http://www.facebook.com&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;http://www.twitter.com&gt;&#39;</span><span class="p">,</span>
    <span class="s2">&#34;&lt;https://www.youtube.com/&gt;&#34;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;http://arstechnica.com/&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;http://www.reuters.com/&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;http://abcnews.go.com/&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;http://www.cnbc.com/&gt;&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">getHtml</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>

<span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
    <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">getHtml</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">url</span><span class="p">,))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Process ID: {os.getpid()}&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;Main thread {threading.main_thread()}&#34;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Thread Count: {threading.active_count()}&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threading</span><span class="o">.</span><span class="n">enumerate</span><span class="p">():</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>运行结果：</p>
<p>




<img loading="lazy" decoding="async"
         src="https://typora-1300715298.cos.ap-shanghai.myqcloud.com/uPic/image-20210624092630425.png"
         alt="image-20210624092630425"
         title="image-20210624092630425.png"
    /></p>
<h3 id="给线程命名">给线程命名</h3>
<p>使用参数来确认或命名线程是笨拙且没有必要的。每一个 <code>Thread</code> 实例创建的时候都有一个带默认值的名字，并且可以修改。在服务端通常一个服务进程都有多个线程服务，负责不同的操作，这时候命名线程是很实用的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">first_function</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">currentThread</span><span class="p">()</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39; is Starting &#39;</span><span class="p">))</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">print</span> <span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">currentThread</span><span class="p">()</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39; is Exiting &#39;</span><span class="p">))</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">second_function</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">currentThread</span><span class="p">()</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39; is Starting &#39;</span><span class="p">))</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">print</span> <span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">currentThread</span><span class="p">()</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39; is Exiting &#39;</span><span class="p">))</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">third_function</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">currentThread</span><span class="p">()</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39; is Starting &#39;</span><span class="p">))</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">currentThread</span><span class="p">()</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39; is Exiting &#39;</span><span class="p">))</span>
    <span class="k">return</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;first_function&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">first_function</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;second_function&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">second_function</span><span class="p">)</span>
    <span class="n">t3</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;third_function&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">third_function</span><span class="p">)</span>
    <span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t3</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>运行结果:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"> <span class="err">✔</span>  <span class="n">python</span> <span class="o">-</span><span class="n">u</span> <span class="n">thread_simple</span><span class="o">.</span><span class="n">pyfirst_function</span> <span class="ow">is</span> <span class="n">Starting</span> <span class="n">second_function</span> <span class="ow">is</span> <span class="n">Starting</span> <span class="n">third_function</span> <span class="ow">is</span> <span class="n">Starting</span> <span class="n">first_function</span> <span class="ow">is</span> <span class="n">Exiting</span> <span class="n">second_function</span> <span class="ow">is</span> <span class="n">Exiting</span> <span class="n">third_function</span> <span class="ow">is</span> <span class="n">Exiting</span> 
</code></pre></td></tr></table>
</div>
</div><h3 id="解析">解析</h3>
<p>我们使用目标函数实例化线程。同时，我们传入 <code>name</code> 参数作为线程的名字，如果不传这个参数，将使用默认的参数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">t1 = threading.Thread(name=&#39;first_function&#39;, target=first_function)t2 = threading.Thread(name=&#39;second_function&#39;, target=second_function)t3 = threading.Thread(target=third_function)
</code></pre></td></tr></table>
</div>
</div><p>（译者注：这里的代码和上面的不一样，可能作者本意是第三个线程不加参数来测试默认的行为，如果改为这里的代码，那么线程3将会输出的是 <code>Thread-1 is Starting</code> 以及 <code>Thread-1 is Exiting</code> ，读者可以自行尝试）</p>
<p>最后调用 <code>start()</code> 和 <code>join()</code> 启动它们。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">t1.start()t2.start()t3.start()t1.join()t2.join()t3.join()
</code></pre></td></tr></table>
</div>
</div><h2 id="5-自己动手实现一个线程">5. 自己动手实现一个线程</h2>
<p>使用threading模块实现一个新的线程，需要下面3步：</p>
<ul>
<li>定义一个 <code>Thread</code> 类的子类</li>
<li>重写 <code>__init__(self [,args])</code> 方法，可以添加额外的参数</li>
<li>最后，需要重写 <code>run(self, [,args])</code> 方法来实现线程要做的事情</li>
</ul>
<p>当你创建了新的 <code>Thread</code> 子类的时候，你可以实例化这个类，调用 <code>start()</code> 方法来启动它。线程启动之后将会执行 <code>run()</code> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">threadingimport</span> <span class="nn">timeexitFlag</span> <span class="o">=</span> <span class="mi">0</span><span class="k">class</span> <span class="nc">myThread</span> <span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threadID</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">counter</span><span class="p">):</span>        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>        <span class="bp">self</span><span class="o">.</span><span class="n">threadID</span> <span class="o">=</span> <span class="n">threadID</span>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Starting &#34;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>        <span class="n">print_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Exiting &#34;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="k">def</span> <span class="nf">print_time</span><span class="p">(</span><span class="n">threadName</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">counter</span><span class="p">):</span>    <span class="k">while</span> <span class="n">counter</span><span class="p">:</span>        <span class="k">if</span> <span class="n">exitFlag</span><span class="p">:</span>            <span class="c1"># 译者注：原书中使用的thread，但是Python3中已经不能使用thread，以_thread取代，因此应该            # import _thread            # _thread.exit()            thread.exit()        time.sleep(delay)        print(&#34;%s: %s&#34; % (threadName, time.ctime(time.time())))        counter -= 1# Create new threadsthread1 = myThread(1, &#34;Thread-1&#34;, 1)thread2 = myThread(2, &#34;Thread-2&#34;, 2)# Start new Threadsthread1.start()thread2.start()# 以下两行为译者添加，如果要获得和图片相同的结果，# 下面两行是必须的。疑似原作者的疏漏thread1.join()thread2.join()print(&#34;Exiting Main Thread&#34;)</span>
</code></pre></td></tr></table>
</div>
</div><p>结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"> <span class="err">✔</span>  <span class="n">python</span> <span class="o">-</span><span class="n">u</span> <span class="n">thread_run</span><span class="o">.</span><span class="n">pyStarting</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">1</span><span class="n">Starting</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span><span class="n">Thread</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Jun</span> <span class="mi">24</span> <span class="mi">09</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">43</span> <span class="mi">2021</span><span class="n">Thread</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Jun</span> <span class="mi">24</span> <span class="mi">09</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">44</span> <span class="mi">2021</span><span class="n">Thread</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Jun</span> <span class="mi">24</span> <span class="mi">09</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">44</span> <span class="mi">2021</span><span class="n">Thread</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Jun</span> <span class="mi">24</span> <span class="mi">09</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">45</span> <span class="mi">2021</span><span class="n">Thread</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Jun</span> <span class="mi">24</span> <span class="mi">09</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">46</span> <span class="mi">2021</span><span class="n">Thread</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Jun</span> <span class="mi">24</span> <span class="mi">09</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">46</span> <span class="mi">2021</span><span class="n">Thread</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Jun</span> <span class="mi">24</span> <span class="mi">09</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">47</span> <span class="mi">2021</span><span class="n">Exiting</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">1</span><span class="n">Thread</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Jun</span> <span class="mi">24</span> <span class="mi">09</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">48</span> <span class="mi">2021</span><span class="n">Thread</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Jun</span> <span class="mi">24</span> <span class="mi">09</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">50</span> <span class="mi">2021</span><span class="n">Thread</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Jun</span> <span class="mi">24</span> <span class="mi">09</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">52</span> <span class="mi">2021</span><span class="n">Exiting</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span><span class="n">Exiting</span> <span class="n">Main</span> <span class="n">Thread</span>
</code></pre></td></tr></table>
</div>
</div><p>解释：</p>
<p><code>threading</code> 模块是创建和管理线程的首选形式。每一个线程都通过一个继承 <code>Thread</code> 类，重写 <code>run()</code> 方法来实现逻辑，这个方法是线程的入口。在主程序中，我们创建了多个 <code>myThread</code> 的类型实例，然后执行 <code>start()</code> 方法启动它们。调用 <code>Thread.__init__</code> 构造器方法是必须的，通过它我们可以给线程定义一些名字或分组之类的属性。调用 <code>start()</code> 之后线程变为活跃状态，并且持续直到 <code>run()</code> 结束，或者中间出现异常。所有的线程都执行完成之后，程序结束。</p>
<p><code>join()</code> 命令控制主线程的终止。</p>
<h2 id="6-线程锁">6. 线程锁🔒</h2>
<p>当两个或以上对共享内存的操作发生在并发线程中，并且至少有一个可以改变数据，又没有同步机制的条件下，就会产生竞争条件，可能会导致执行无效代码、bug、或异常行为。</p>
<p>竞争条件最简单的解决方法是使用锁。锁的操作非常简单，当一个线程需要访问部分共享内存时，它必须先获得锁才能访问。此线程对这部分共享资源使用完成之后，该线程必须释放锁，然后其他线程就可以拿到这个锁并访问这部分资源了。</p>
<p>然而，在实际使用的过程中，我们发现这个方法经常会导致一种糟糕的死锁现象。当不同的线程要求得到一个锁时，死锁就会发生，这时程序不可能继续执行，因为它们互相拿着对方需要的锁。使用锁来解决同步问题是一个可行却存在潜在问题的方案。</p>
<h3 id="61-代码解释">6.1 代码解释</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># -*- coding: utf-8 -*-import threadingshared_resource_with_lock = 0shared_resource_with_no_lock = 0COUNT = 100000shared_resource_lock = threading.Lock()# 有锁的情况def increment_with_lock():    global shared_resource_with_lock    for i in range(COUNT):        shared_resource_lock.acquire()        shared_resource_with_lock += 1        shared_resource_lock.release()def decrement_with_lock():    global shared_resource_with_lock    for i in range(COUNT):        shared_resource_lock.acquire()        shared_resource_with_lock -= 1        shared_resource_lock.release()# 没有锁的情况def increment_without_lock():    global shared_resource_with_no_lock    for i in range(COUNT):        shared_resource_with_no_lock += 1def decrement_without_lock():    global shared_resource_with_no_lock    for i in range(COUNT):        shared_resource_with_no_lock -= 1if __name__ == &#34;__main__&#34;:    t1 = threading.Thread(target=increment_with_lock)    t2 = threading.Thread(target=decrement_with_lock)    t3 = threading.Thread(target=increment_without_lock)    t4 = threading.Thread(target=decrement_without_lock)    t1.start()    t2.start()    t3.start()    t4.start()    t1.join()    t2.join()    t3.join()    t4.join()    print (&#34;the value of shared variable with lock management is %s&#34; % shared_resource_with_lock)    print (&#34;the value of shared variable with race condition is %s&#34; % shared_resource_with_no_lock)</span>
</code></pre></td></tr></table>
</div>
</div><p>运行结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"> <span class="err">✔</span>  <span class="n">python</span> <span class="o">-</span><span class="n">u</span> <span class="n">thread_lock</span><span class="o">.</span><span class="n">pythe</span> <span class="n">value</span> <span class="n">of</span> <span class="n">shared</span> <span class="n">variable</span> <span class="k">with</span> <span class="n">lock</span> <span class="n">management</span> <span class="ow">is</span> <span class="mi">0</span><span class="n">the</span> <span class="n">value</span> <span class="n">of</span> <span class="n">shared</span> <span class="n">variable</span> <span class="k">with</span> <span class="n">race</span> <span class="n">condition</span> <span class="ow">is</span> <span class="mi">67058</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看出，如果有锁来管理线程的话，我们会得到正确的结果。这里要注意，没有锁的情况下并不一定会得到错误的结果，但是重复执行多次，总会出现错误的结果。而有锁的情况结果总会是正确的。</p>
<h3 id="62-代码解释">6.2 代码解释</h3>
<p>在主程序中，我们有以下步骤：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">t1 = threading.Thread(target=increment_with_lock)t2 = threading.Thread(target=decrement_with_lock)
</code></pre></td></tr></table>
</div>
</div><p>启动线程：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">t1.start()t2.start()
</code></pre></td></tr></table>
</div>
</div><p>然后阻塞主线程直到所有线程完成：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">t1.join()t2.join()
</code></pre></td></tr></table>
</div>
</div><p>在 <code>increment_with_lock()</code> 函数和 <code>decrement_with_lock()</code> 函数中，可以看到我们使用了lock语句。当你需要使用资源的时候，调用 <code>acquire()</code> 拿到锁（如果锁暂时不可用，会一直等待直到拿到），最后调用 <code>release()</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">shared_resource_lock.acquire()shared_resource_with_lock -= 1shared_resource_lock.release()
</code></pre></td></tr></table>
</div>
</div><p>让我们总结一下：</p>
<ul>
<li>锁有两种状态： locked（被某一线程拿到）和unlocked（可用状态）</li>
<li>我们有两个方法来操作锁： <code>acquire()</code> 和 <code>release()</code></li>
</ul>
<p>需要遵循以下规则：</p>
<ul>
<li>如果状态是unlocked， 可以调用 <code>acquire()</code> 将状态改为locked</li>
<li>如果状态是locked， <code>acquire()</code> 会被block直到另一线程调用 <code>release()</code> 释放锁</li>
<li>如果状态是unlocked， 调用 <code>release()</code> 将导致 <code>RuntimError</code> 异常</li>
<li>如果状态是locked， 可以调用 <code>release()</code> 将状态改为unlocked</li>
</ul>
<h3 id="63-线程弊端">6.3. 线程弊端</h3>
<p>尽管理论上行得通，但是锁的策略不仅会导致有害的僵持局面。还会对应用程序的其他方面产生负面影响。这是一种保守的方法，经常会引起不必要的开销，也会限制程序的可扩展性和可读性。更重要的是，有时候需要对多进程共享的内存分配优先级，使用锁可能和这种优先级冲突。最后，从实践的经验来看，使用锁的应用将对debug带来不小的麻烦。所以，最好使用其他可选的方法确保同步读取共享内存，避免竞争条件。</p>
<h2 id="7-递归锁rlock">7. 递归锁RLOCK</h2>
<p>RLock其实叫做“Reentrant Lock”，就是可以重复进入的锁，也叫做“递归锁”。这种锁对比Lock有是三个特点：1. 谁拿到谁释放。如果线程A拿到锁，线程B无法释放这个锁，只有A可以释放；2. 同一线程可以多次拿到该锁，即可以acquire多次；3. acquire多少次就必须release多少次，只有最后一次release才能改变RLock的状态为unlocked</p>
<p>如果是一把互斥锁（threading.Lock()），那么下面的代码会发生堵塞：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">threadinglock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;获取第二把锁&#39;</span><span class="p">)</span>        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;test.......{i}&#39;</span><span class="p">)</span>        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>    <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>同样的代码，如果换成（threading.RLock()），则不会发生堵塞：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">threadinglock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;获取第二把锁&#39;</span><span class="p">)</span>        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;test.......{i}&#39;</span><span class="p">)</span>        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>    <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>RLock其实底层维护了一个互斥锁和一个计数器</strong></p>
<h2 id="8-信号量">8. 信号量</h2>
<p><strong>信号量也是一把锁，用来控制线程并发数的</strong>。BoundedSemaphore或Semaphore管理一个内置的计数 器，每当调用acquire()时-1，调用release()时+1。</p>
<p>计数器不能小于0，当计数器为 0时，acquire()将阻塞线程至同步锁定状态，直到其他线程调用release()。(类似于停车位的概念)</p>
<p>类名：BoundedSemaphore。这种锁允许一定数量的线程同时更改数据，它不是互斥锁。比如地铁安检，排队人很多，工作人员只允许一定数量的人进入安检区，其它的人继续排队。</p>
<p>同样的，在threading模块中，信号量的操作有两个函数，即 <code>acquire()</code> 和 <code>release()</code> ，解释如下：</p>
<ul>
<li>每当线程想要读取关联了信号量的共享资源时，必须调用 <code>acquire()</code> ，此操作减少信号量的内部变量, 如果此变量的值非负，那么分配该资源的权限。如果是负值，那么线程被挂起，直到有其他的线程释放资源。</li>
<li>当线程不再需要该共享资源，必须通过 <code>release()</code> 释放。这样，信号量的内部变量增加，在信号量等待队列中排在最前面的线程会拿到共享资源的权限。</li>
</ul>
<p>




<img loading="lazy" decoding="async"
         src="https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/semaphores.png"
         alt="../_images/semaphores.png"
         title="semaphores.png"
    /></p>
<h3 id="81-代码">8.1 代码</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">timeimport</span> <span class="nn">threadingdef</span> <span class="nn">run</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">se</span><span class="p">):</span>    <span class="n">se</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;run the thread: </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>    <span class="n">se</span><span class="o">.</span><span class="n">release</span><span class="p">()</span><span class="c1"># 设置允许5个线程同时运行semaphore = threading.BoundedSemaphore(5)for i in range(20):    t = threading.Thread(target=run, args=(i, semaphore))    t.start()</span>
</code></pre></td></tr></table>
</div>
</div><p>运行结果：</p>
<p>​	




<img loading="lazy" decoding="async"
         src="https://typora-1300715298.cos.ap-shanghai.myqcloud.com/uPic/image-20210624101949016.png"
         alt="BoundedSemaphore"
         title="image-20210624101949016.png"
    /></p>
<h3 id="82-消费者模型的信号量使用">8.2 消费者模型的信号量使用</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># -*- coding: utf-8 -*-&#34;&#34;&#34;Using a Semaphore to synchronize threads&#34;&#34;&#34;import threadingimport timeimport random# The optional argument gives the initial value for the internal# counter;# it defaults to 1.# If the value given is less than 0, ValueError is raised.semaphore = threading.Semaphore(0)def consumer():        print(&#34;consumer is waiting.&#34;)        # Acquire a semaphore        semaphore.acquire()        # The consumer have access to the shared resource        print(&#34;Consumer notify : consumed item number %s &#34; % item)def producer():        global item        time.sleep(10)        # create a random item        item = random.randint(0, 1000)        print(&#34;producer notify : produced item number %s&#34; % item)         # Release a semaphore, incrementing the internal counter by one.        # When it is zero on entry and another thread is waiting for it        # to become larger than zero again, wake up that thread.        semaphore.release()if __name__ == &#39;__main__&#39;:        for i in range (0,5) :                t1 = threading.Thread(target=producer)                t2 = threading.Thread(target=consumer)                t1.start()                t2.start()                t1.join()                t2.join()        print(&#34;program terminated&#34;)</span>
</code></pre></td></tr></table>
</div>
</div><p>我们使用生产者-消费者模型展示通过信号量的同步。当生产者生产出item，便释放信号量。然后消费者拿到资源进行消费。</p>
<p>运行结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"> <span class="err">↵</span>  <span class="n">python</span> <span class="o">-</span><span class="n">u</span> <span class="n">thread_semaphore</span><span class="o">.</span><span class="n">pyconsumer</span> <span class="ow">is</span> <span class="n">waiting</span><span class="o">.</span><span class="n">producer</span> <span class="n">notify</span> <span class="p">:</span> <span class="n">produced</span> <span class="n">item</span> <span class="n">number</span> <span class="mi">328</span><span class="n">Consumer</span> <span class="n">notify</span> <span class="p">:</span> <span class="n">consumed</span> <span class="n">item</span> <span class="n">number</span> <span class="mi">328</span> <span class="n">consumer</span> <span class="ow">is</span> <span class="n">waiting</span><span class="o">.</span><span class="n">producer</span> <span class="n">notify</span> <span class="p">:</span> <span class="n">produced</span> <span class="n">item</span> <span class="n">number</span> <span class="mi">230</span><span class="n">Consumer</span> <span class="n">notify</span> <span class="p">:</span> <span class="n">consumed</span> <span class="n">item</span> <span class="n">number</span> <span class="mi">230</span> <span class="n">consumer</span> <span class="ow">is</span> <span class="n">waiting</span><span class="o">.</span><span class="n">producer</span> <span class="n">notify</span> <span class="p">:</span> <span class="n">produced</span> <span class="n">item</span> <span class="n">number</span> <span class="mi">174</span><span class="n">Consumer</span> <span class="n">notify</span> <span class="p">:</span> <span class="n">consumed</span> <span class="n">item</span> <span class="n">number</span> <span class="mi">174</span> <span class="n">consumer</span> <span class="ow">is</span> <span class="n">waiting</span><span class="o">.</span><span class="n">producer</span> <span class="n">notify</span> <span class="p">:</span> <span class="n">produced</span> <span class="n">item</span> <span class="n">number</span> <span class="mi">573</span><span class="n">Consumer</span> <span class="n">notify</span> <span class="p">:</span> <span class="n">consumed</span> <span class="n">item</span> <span class="n">number</span> <span class="mi">573</span> <span class="n">consumer</span> <span class="ow">is</span> <span class="n">waiting</span><span class="o">.</span><span class="n">producer</span> <span class="n">notify</span> <span class="p">:</span> <span class="n">produced</span> <span class="n">item</span> <span class="n">number</span> <span class="mi">286</span><span class="n">Consumer</span> <span class="n">notify</span> <span class="p">:</span> <span class="n">consumed</span> <span class="n">item</span> <span class="n">number</span> <span class="mi">286</span> <span class="n">program</span> <span class="n">terminated</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="9-条件线程设置">9. 条件线程设置</h2>
<p>条件指的是应用程序状态的改变。这是另一种同步机制，其中某些线程在等待某一条件发生，其他的线程会在该条件发生的时候进行通知。一旦条件发生，线程会拿到共享资源的唯一权限。</p>
<h3 id="91-代码">9.1 代码</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">Conditionimport</span> <span class="n">timeitems</span> <span class="o">=</span> <span class="p">[]</span><span class="n">condition</span> <span class="o">=</span> <span class="n">Condition</span><span class="p">()</span><span class="k">class</span> <span class="nc">consumer</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>    <span class="k">def</span> <span class="nf">consume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">global</span> <span class="n">condition</span>        <span class="k">global</span> <span class="n">items</span>        <span class="n">condition</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>            <span class="n">condition</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>            <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Consumer notify : no item to consume&#34;</span><span class="p">)</span>        <span class="n">items</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Consumer notify : consumed 1 item&#34;</span><span class="p">)</span>        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Consumer notify : items to consume are &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)))</span>        <span class="n">condition</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>        <span class="n">condition</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>            <span class="bp">self</span><span class="o">.</span><span class="n">consume</span><span class="p">()</span><span class="k">class</span> <span class="nc">producer</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>    <span class="k">def</span> <span class="nf">produce</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">global</span> <span class="n">condition</span>        <span class="k">global</span> <span class="n">items</span>        <span class="n">condition</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>            <span class="n">condition</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>            <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Producer notify : items producted are &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)))</span>            <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Producer notify : stop the production!!&#34;</span><span class="p">)</span>        <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Producer notify : total items producted &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)))</span>        <span class="n">condition</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>        <span class="n">condition</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>            <span class="bp">self</span><span class="o">.</span><span class="n">produce</span><span class="p">()</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>    <span class="n">producer</span> <span class="o">=</span> <span class="n">producer</span><span class="p">()</span>    <span class="n">consumer</span> <span class="o">=</span> <span class="n">consumer</span><span class="p">()</span>    <span class="n">producer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>    <span class="n">consumer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>    <span class="n">producer</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>    <span class="n">consumer</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>运行结果：</p>
<p>




<img loading="lazy" decoding="async"
         src="https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/Page-75-Image-12.png"
         alt="../_images/Page-75-Image-12.png"
         title="Page-75-Image-12.png"
    /></p>
<p>(译者在这里添加一段。乍一看这段代码好像会死锁，因为 <code>condition.acquire()</code> 之后就在 <code>.wait()</code> 了，好像会一直持有锁。其实 <code>.wait()</code> 会将锁释放，然后等待其他线程 <code>.notify()</code> 之后会重新尝试获得锁。但是要注意 <code>.notify()</code> 并不会自动释放锁，所以代码中有两行，先 <code>.notify()</code> 然后再 <code>.release()</code> 。</p>
<p>译者画了一张图，方便大家理解。这里的过程应该是这样子的（注意 <code>wait()</code> 里面实际有一个释放锁重新获得锁的过程）：</p>
<p>




<img loading="lazy" decoding="async"
         src="https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/python-condition.png"
         alt="../_images/python-condition.png"
         title="python-condition.png"
    /></p>
<p>译者的私货完毕，建议看一下官方文档： <a href="https://docs.python.org/3/library/threading.html">https://docs.python.org/3/library/threading.html</a> )</p>
<p>消费者通过拿到锁来修改共享的资源 <code>items[]</code> ：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">condition.acquire()
</code></pre></td></tr></table>
</div>
</div><p>如果list的长度为0，那么消费者就进入等待状态：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">if len(items) == 0:    condition.wait()
</code></pre></td></tr></table>
</div>
</div><p>否则就通过 <code>pop</code> 操作消费一个item：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">items.pop()
</code></pre></td></tr></table>
</div>
</div><p>然后，消费者的状态被通知给生产者，同时共享资源释放：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">condition.notify()condition.release()
</code></pre></td></tr></table>
</div>
</div><p>生产者拿到共享资源，然后确认缓冲队列是否已满（在我们的这个例子中，最大可以存放10个item），如果已经满了，那么生产者进入等待状态，直到被唤醒：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">condition.acquire()if len(items) == 10:    condition.wait()
</code></pre></td></tr></table>
</div>
</div><p>如果队列没有满，就生产1个item，通知状态并释放资源：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">condition.notify()condition.release()
</code></pre></td></tr></table>
</div>
</div><h2 id="10-事件进行线程同步">10. 事件进行线程同步</h2>
<p>事件是线程之间用于通讯的对象。有的线程等待信号，有的线程发出信号。基本上事件对象都会维护一个内部变量，可以通过 <code>set()</code> 方法设置为 <code>true</code> ，也可以通过 <code>clear()</code> 方法设置为 <code>false</code> 。 <code>wait()</code> 方法将会阻塞线程，直到内部变量为 <code>true</code> 。</p>
<h3 id="101-代码">10.1 代码</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">timefrom</span> <span class="nn">threading</span> <span class="nn">import</span> <span class="nn">Thread</span><span class="o">,</span> <span class="nn">Eventimport</span> <span class="nn">randomitems</span> <span class="o">=</span> <span class="p">[]</span><span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span><span class="k">class</span> <span class="nc">consumer</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>        <span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">items</span>        <span class="bp">self</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">event</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>            <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Consumer notify : </span><span class="si">%d</span><span class="s1"> popped from list by </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span><span class="k">class</span> <span class="nc">producer</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>        <span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">items</span>        <span class="bp">self</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">event</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">global</span> <span class="n">item</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>            <span class="n">item</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>            <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Producer notify : item N° </span><span class="si">%d</span><span class="s1"> appended to list by </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Producer notify : event set by </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>            <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Produce notify : event cleared by </span><span class="si">%s</span><span class="s1"> &#39;</span><span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>            <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>    <span class="n">t1</span> <span class="o">=</span> <span class="n">producer</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>    <span class="n">t2</span> <span class="o">=</span> <span class="n">consumer</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>    <span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>    <span class="n">t2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>    <span class="n">t1</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>    <span class="n">t2</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>线程t1在list最后添加值，然后设置event来通知消费者。消费者通过 <code>wait()</code> 阻塞，直到收到信号的时候从list中取出元素消费。</p>
<p>运行结果：</p>
<p>




<img loading="lazy" decoding="async"
         src="https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/Page-78-Image-13.png"
         alt="../_images/Page-78-Image-13.png"
         title="Page-78-Image-13.png"
    /></p>
<p>解释：</p>
<p><code>producer</code> 类初始化时定义了item的list和 <code>Event</code> ，与条件对象时候的例子不同，这里的list并不是全局的，而是通过参数传入的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">class consumer(Thread):    def __init__(self, items, event):        Thread.__init__(self)        self.items = items        self.event = event
</code></pre></td></tr></table>
</div>
</div><p>在run方法中，每当item创建， <code>producer</code> 类将新item添加到list末尾然后发出事件通知。使用事件有两步，第一步：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">self.event.set()
</code></pre></td></tr></table>
</div>
</div><p>第二步：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">self.event.clear()
</code></pre></td></tr></table>
</div>
</div><p><code>consumer</code> 类初始化时也定义了item的list和 <code>Event()</code> 。当item进来的时候，它将其取出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">def run(self):    while True:        time.sleep(2)        self.event.wait()        item = self.items.pop()        print(&#39;Consumer notify : %d popped from list by %s&#39; % (item, self.name))
</code></pre></td></tr></table>
</div>
</div><p>下图可以帮我们认识 <code>producer</code> 和 <code>consumer</code> ：</p>
<p>




<img loading="lazy" decoding="async"
         src="https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/event.png"
         alt="../_images/event.png"
         title="event.png"
    /></p>
<h2 id="11-线程中的with语句">11. 线程中的with语句</h2>
<p>Python从2.5版本开始引入了 <code>with</code> 语法。此语法非常实用，在有两个相关的操作需要在一部分代码块前后分别执行的时候，可以使用 <code>with</code> 语法自动完成。同事，使用 <code>with</code> 语法可以在特定的地方分配和释放资源，因此， <code>with</code> 语法也叫做“上下文管理器”。在threading模块中，所有带有 <code>acquire()</code> 方法和 <code>release()</code> 方法的对象都可以使用上下文管理器。</p>
<p>也就是说，下面的对象可以使用 <code>with</code> 语法：</p>
<ul>
<li>Lock</li>
<li>RLock</li>
<li>Condition</li>
<li>Semaphore</li>
</ul>
<h3 id="111-代码">11.1 代码</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">threadingimport</span> <span class="nn">logginglogging.basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;(</span><span class="si">%(threadName)-10s</span><span class="s1">) </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,)</span><span class="k">def</span> <span class="nf">threading_with</span><span class="p">(</span><span class="n">statement</span><span class="p">):</span>    <span class="k">with</span> <span class="n">statement</span><span class="p">:</span>        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> acquired via with&#39;</span> <span class="o">%</span> <span class="n">statement</span><span class="p">)</span><span class="k">def</span> <span class="nf">threading_not_with</span><span class="p">(</span><span class="n">statement</span><span class="p">):</span>    <span class="n">statement</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>    <span class="k">try</span><span class="p">:</span>        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> acquired directly&#39;</span> <span class="o">%</span> <span class="n">statement</span> <span class="p">)</span>    <span class="k">finally</span><span class="p">:</span>        <span class="n">statement</span><span class="o">.</span><span class="n">release</span><span class="p">()</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>    <span class="c1"># let&#39;s create a test battery    lock = threading.Lock()    rlock = threading.RLock()    condition = threading.Condition()    mutex = threading.Semaphore(1)    threading_synchronization_list = [lock, rlock, condition, mutex]    # in the for cycle we call the threading_with e threading_no_with function    for statement in threading_synchronization_list :       t1 = threading.Thread(target=threading_with, args=(statement,))       t2 = threading.Thread(target=threading_not_with, args=(statement,))       t1.start()       t2.start()       t1.join()       t2.join()</span>
</code></pre></td></tr></table>
</div>
</div><p>运行结果:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="err">↵</span> <span class="n">python</span> <span class="o">-</span><span class="n">u</span> <span class="n">thread_with</span><span class="o">.</span><span class="n">py</span><span class="p">(</span><span class="n">Thread</span><span class="o">-</span><span class="mi">1</span>  <span class="p">)</span> <span class="o">&lt;</span><span class="n">locked</span> <span class="n">_thread</span><span class="o">.</span><span class="n">lock</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x1019a1450</span><span class="o">&gt;</span> <span class="n">acquired</span> <span class="n">via</span> <span class="k">with</span><span class="p">(</span><span class="n">Thread</span><span class="o">-</span><span class="mi">2</span>  <span class="p">)</span> <span class="o">&lt;</span><span class="n">locked</span> <span class="n">_thread</span><span class="o">.</span><span class="n">lock</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x1019a1450</span><span class="o">&gt;</span> <span class="n">acquired</span> <span class="n">directly</span><span class="p">(</span><span class="n">Thread</span><span class="o">-</span><span class="mi">3</span>  <span class="p">)</span> <span class="o">&lt;</span><span class="n">locked</span> <span class="n">_thread</span><span class="o">.</span><span class="n">RLock</span> <span class="nb">object</span> <span class="n">owner</span><span class="o">=</span><span class="mi">123145583611904</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span> <span class="n">at</span> <span class="mh">0x1019a1420</span><span class="o">&gt;</span> <span class="n">acquired</span> <span class="n">via</span> <span class="k">with</span><span class="p">(</span><span class="n">Thread</span><span class="o">-</span><span class="mi">4</span>  <span class="p">)</span> <span class="o">&lt;</span><span class="n">locked</span> <span class="n">_thread</span><span class="o">.</span><span class="n">RLock</span> <span class="nb">object</span> <span class="n">owner</span><span class="o">=</span><span class="mi">123145583611904</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span> <span class="n">at</span> <span class="mh">0x1019a1420</span><span class="o">&gt;</span> <span class="n">acquired</span> <span class="n">directly</span><span class="p">(</span><span class="n">Thread</span><span class="o">-</span><span class="mi">5</span>  <span class="p">)</span> <span class="o">&lt;</span><span class="n">Condition</span><span class="p">(</span><span class="o">&lt;</span><span class="n">locked</span> <span class="n">_thread</span><span class="o">.</span><span class="n">RLock</span> <span class="nb">object</span> <span class="n">owner</span><span class="o">=</span><span class="mi">123145583611904</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span> <span class="n">at</span> <span class="mh">0x1019a19c0</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">acquired</span> <span class="n">via</span> <span class="k">with</span><span class="p">(</span><span class="n">Thread</span><span class="o">-</span><span class="mi">6</span>  <span class="p">)</span> <span class="o">&lt;</span><span class="n">Condition</span><span class="p">(</span><span class="o">&lt;</span><span class="n">locked</span> <span class="n">_thread</span><span class="o">.</span><span class="n">RLock</span> <span class="nb">object</span> <span class="n">owner</span><span class="o">=</span><span class="mi">123145600401408</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span> <span class="n">at</span> <span class="mh">0x1019a19c0</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">acquired</span> <span class="n">directly</span><span class="p">(</span><span class="n">Thread</span><span class="o">-</span><span class="mi">7</span>  <span class="p">)</span> <span class="o">&lt;</span><span class="n">threading</span><span class="o">.</span><span class="n">Semaphore</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x101818910</span><span class="o">&gt;</span> <span class="n">acquired</span> <span class="n">via</span> <span class="k">with</span><span class="p">(</span><span class="n">Thread</span><span class="o">-</span><span class="mi">8</span>  <span class="p">)</span> <span class="o">&lt;</span><span class="n">threading</span><span class="o">.</span><span class="n">Semaphore</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x101818910</span><span class="o">&gt;</span> <span class="n">acquired</span> <span class="n">directly</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="102-解释">10.2 解释</h3>
<p>在主程序中，我们定义了一个list， <code>threading_synchronization_list</code> ，包含要测试的线程同步使用的对象：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">lock = threading.Lock()rlock = threading.RLock()condition = threading.Condition()mutex = threading.Semaphore(1)threading_synchronization_list = [lock, rlock, condition, mutex]
</code></pre></td></tr></table>
</div>
</div><p>定义之后，我们可以在 <code>for</code> 循环中测试每一个对象：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">for statement in threading_synchronization_list :   t1 = threading.Thread(target=threading_with, args=(statement,))   t2 = threading.Thread(target=threading_not_with, args=(statement,))
</code></pre></td></tr></table>
</div>
</div><p>最后，我们有两个目标函数，其中 <code>threading_with</code> 测试了 <code>with</code> 语法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">def threading_with(statement):    with statement:        logging.debug(&#39;%s acquired via with&#39; % statement)
</code></pre></td></tr></table>
</div>
</div><h2 id="12-使用队列进行线程通信">12. 使用队列进行线程通信</h2>
<p>当线程之间如果要共享资源或数据的时候，可能变的非常复杂。如你所见，Python的threading模块提供了很多同步原语，包括信号量，条件变量，事件和锁。如果可以使用这些原语的话，应该优先考虑使用这些，而不是使用queue（队列）模块。队列操作起来更容易，也使多线程编程更安全，因为队列可以将资源的使用通过单线程进行完全控制，并且允许使用更加整洁和可读性更高的设计模式。</p>
<p>Queue常用的方法有以下四个：</p>
<ul>
<li><code>put()</code>: 往queue中放一个item</li>
<li><code>get()</code>: 从queue删除一个item，并返回删除的这个item</li>
<li><code>task_done()</code>: 每次item被处理的时候需要调用这个方法</li>
<li><code>join()</code>: 所有item都被处理之前一直阻塞</li>
</ul>
<h3 id="122-代码">12.2 代码</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">Eventfrom</span> <span class="n">queue</span> <span class="kn">import</span> <span class="nn">Queueimport</span> <span class="nn">timeimport</span> <span class="nn">randomclass</span> <span class="nn">producer</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>        <span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>            <span class="n">item</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Producer notify: item N° </span><span class="si">%d</span><span class="s1"> appended to queue by </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="k">class</span> <span class="nc">consumer</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>        <span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Consumer notify : </span><span class="si">%d</span><span class="s1"> popped from queue by </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>    <span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>    <span class="n">t1</span> <span class="o">=</span> <span class="n">producer</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>    <span class="n">t2</span> <span class="o">=</span> <span class="n">consumer</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>    <span class="n">t3</span> <span class="o">=</span> <span class="n">consumer</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>    <span class="n">t4</span> <span class="o">=</span> <span class="n">consumer</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>    <span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>    <span class="n">t2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>    <span class="n">t3</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>    <span class="n">t4</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>    <span class="n">t1</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>    <span class="n">t2</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>    <span class="n">t3</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>    <span class="n">t4</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>运行结果：</p>
<p>




<img loading="lazy" decoding="async"
         src="https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/Page-85-Image-15.png"
         alt="../_images/Page-85-Image-15.png"
         title="Page-85-Image-15.png"
    /></p>
<h3 id="122-解释">12.2 解释</h3>
<p>首先，我们创建一个生产者类。由于我们使用队列存放数字，所以不需要用来存放数字的list了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">class producer(Thread):    def __init__(self, queue):        Thread.__init__(self)        self.queue = queue
</code></pre></td></tr></table>
</div>
</div><p><code>producer</code> 类生产整数，然后通过一个 <code>for</code> 循环将整数放到队列中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">def run(self) :    for i in range(10):        item = random.randint(0, 256)        self.queue.put(item)        print(&#39;Producer notify: item N° %d appended to queue by %s&#39; % (item, self.name))        time.sleep(1)
</code></pre></td></tr></table>
</div>
</div><p>生产者使用 <code>Queue.put(item [,block[, timeout]])</code> 来往queue中插入数据。Queue是同步的，在插入数据之前内部有一个内置的锁机制。</p>
<p>可能发生两种情况：</p>
<ul>
<li>如果 <code>block</code> 为 <code>True</code> ， <code>timeout</code> 为 <code>None</code> （这也是默认的选项，本例中使用默认选项），那么可能会阻塞掉，直到出现可用的位置。如果 <code>timeout</code> 是正整数，那么阻塞直到这个时间，就会抛出一个异常。</li>
<li>如果 <code>block</code> 为 <code>False</code> ，如果队列有闲置那么会立即插入，否则就立即抛出异常（ <code>timeout</code> 将会被忽略）。本例中， <code>put()</code> 检查队列是否已满，然后调用 <code>wait()</code> 开始等待。</li>
</ul>
<p>消费者从队列中取出整数然后用 <code>task_done()</code> 方法将其标为任务已处理。</p>
<p>消费者使用 <code>Queue.get([block[, timeout]])</code> 从队列中取回数据，queue内部也会经过锁的处理。如果队列为空，消费者阻塞。</p>
<p>最后，在主程序中，我们创建线程t作为生产者，t1, t2, t3作为消费者：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">if __name__ == &#39;__main__&#39;:    queue = Queue()    t1 = producer(queue)    t2 = consumer(queue)    t3 = consumer(queue)    t4 = consumer(queue)    t1.start()    t2.start()    t3.start()    t4.start()    t1.join()    t2.join()    t3.join()    t4.join()
</code></pre></td></tr></table>
</div>
</div><p>生产者和消费者之间的操作可以用下图来描述：</p>
<p>




<img loading="lazy" decoding="async"
         src="https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/queue.png"
         alt="../_images/queue.png"
         title="queue.png"
    /></p>
<h2 id="13-评估多线程应用的性能">13. 评估多线程应用的性能</h2>
<p>在本节中，我们将验证GIL的影响，评估多线程应用的性能。前文已经介绍过，GIL是CPython解释器引入的锁，GIL在解释器层面阻止了真正的并行运行。解释器在执行任何线程之前，必须等待当前正在运行的线程释放GIL。事实上，解释器会强迫想要运行的线程必须拿到GIL才能访问解释器的任何资源，例如栈或Python对象等。这也正是GIL的目的——阻止不同的线程并发访问Python对象。这样GIL可以保护解释器的内存，让垃圾回收工作正常。但事实上，这却造成了程序员无法通过并行执行多线程来提高程序的性能。如果我们去掉CPython的GIL，就可以让多线程真正并行执行。GIL并没有影响多处理器并行的线程，只是限制了一个解释器只能有一个线程在运行。</p>
<h3 id="131-代码">13.1 代码</h3>
<p>下面的代码是用来评估多线程应用性能的简单工具。下面的每一个测试都循环调用函数100次，重复执行多次，取速度最快的一次。在 <code>for</code> 循环中，我们调用 <code>non_threaded</code> 和 <code>threaded</code> 函数。同时，我们会不断增加调用次数和线程数来重复执行这个测试。我们会尝试使用1，2，3，4和8线程数来调用线程。在非线程的测试中，我们顺序调用函数与对应线程数一样多的次数。为了保持简单，度量的指标使用Python的内建模块timer。</p>
<p>代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Threadclass</span> <span class="n">threads_object</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="n">function_to_run</span><span class="p">()</span><span class="k">class</span> <span class="nc">nothreads_object</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="n">function_to_run</span><span class="p">()</span><span class="k">def</span> <span class="nf">non_threaded</span><span class="p">(</span><span class="n">num_iter</span><span class="p">):</span>    <span class="n">funcs</span> <span class="o">=</span> <span class="p">[]</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">num_iter</span><span class="p">)):</span>        <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nothreads_object</span><span class="p">())</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>        <span class="n">i</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="k">def</span> <span class="nf">threaded</span><span class="p">(</span><span class="n">num_threads</span><span class="p">):</span>    <span class="n">funcs</span> <span class="o">=</span> <span class="p">[]</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">num_threads</span><span class="p">)):</span>        <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">threads_object</span><span class="p">())</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>        <span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>        <span class="n">i</span><span class="o">.</span><span class="n">join</span><span class="p">()</span><span class="k">def</span> <span class="nf">function_to_run</span><span class="p">():</span>    <span class="n">passdef</span> <span class="n">show_results</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%-23s</span><span class="s2"> </span><span class="si">%4.6f</span><span class="s2"> seconds&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">results</span><span class="p">))</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>    <span class="kn">import</span> <span class="nn">sys</span>    <span class="nn">from</span> <span class="nn">timeit</span> <span class="nn">import</span> <span class="nn">Timer</span>    <span class="nn">repeat</span> <span class="o">=</span> <span class="mi">100</span>    <span class="n">number</span> <span class="o">=</span> <span class="mi">1</span>    <span class="n">num_threads</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Starting tests&#39;</span><span class="p">)</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">num_threads</span><span class="p">:</span>        <span class="n">t</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="s2">&#34;non_threaded(</span><span class="si">%s</span><span class="s2">)&#34;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&#34;from __main__ import non_threaded&#34;</span><span class="p">)</span>        <span class="n">best_result</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">repeat</span><span class="o">=</span><span class="n">repeat</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">))</span>        <span class="n">show_results</span><span class="p">(</span><span class="s2">&#34;non_threaded (</span><span class="si">%s</span><span class="s2"> iters)&#34;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">best_result</span><span class="p">)</span>        <span class="n">t</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="s2">&#34;threaded(</span><span class="si">%s</span><span class="s2">)&#34;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&#34;from __main__ import threaded&#34;</span><span class="p">)</span>        <span class="n">best_result</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">repeat</span><span class="o">=</span><span class="n">repeat</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">))</span>        <span class="n">show_results</span><span class="p">(</span><span class="s2">&#34;threaded (</span><span class="si">%s</span><span class="s2"> threads)&#34;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">best_result</span><span class="p">)</span>        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Iterations complete&#39;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="132-解释">13.2. 解释</h2>
<p>我们一共进行了四次测试(译者注：原文是three，我怀疑原作者不识数，原文的3个线程数也没有写在代码里），每一次都会使用不同的function进行测试，只要改变 <code>function_to_run()</code> 就可以了。</p>
<p>测试用的机器是 Core 2 Duo CPU – 2.33Ghz。</p>
<h3 id="第一次测试">第一次测试</h3>
<p>在第一次测试中，我们使用了一个简单的空函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">def function_to_run():    pass
</code></pre></td></tr></table>
</div>
</div><p>下图展示了我们测试的每个机制的运行速度：</p>
<p>




<img loading="lazy" decoding="async"
         src="https://typora-1300715298.cos.ap-shanghai.myqcloud.com/uPic/image-20210624105756890.png"
         alt="test1"
         title="image-20210624105756890.png"
    /></p>
<p>通过结果可以发现，使用线程的开销要比不使用线程的开销大的多。特别的，我们发现随着线程的数量增加，带来的开销是成比例的。4个线程的运行时间是0.000162秒，8个线程的运行时间是0.000316秒。</p>
<h3 id="第二次测试">第二次测试</h3>
<p>多线程比较常用的一个用途是处理数字，下面的测试计算斐波那契数列，注意这个例子中没有共享的资源，只是测试生成数字数列：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">def function_to_run():    a, b = 0, 1    for i in range(10000):        a, b = b, a + b
</code></pre></td></tr></table>
</div>
</div><p>输出如下：</p>
<p>




<img loading="lazy" decoding="async"
         src="https://typora-1300715298.cos.ap-shanghai.myqcloud.com/uPic/image-20210624105829147.png"
         alt="image-20210624105829147"
         title="image-20210624105829147.png"
    /></p>
<p>在输出中可以看到，提高线程的数量并没有带来收益。因为GIL和线程管理代码的开销，多线程运行永远不可能比函数顺序执行更快。再次提醒一下：GIL只允许解释器一次执行一个线程。</p>
<h3 id="第三次测试">第三次测试</h3>
<p>下面的测试是读1kb的数据1000次，测试用的函数如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">def function_to_run():    fh=open(&#34;C:\\CookBookFileExamples\\test.dat&#34;,&#34;rb&#34;)    size = 1024    for i in range(1000):        fh.read(size)
</code></pre></td></tr></table>
</div>
</div><p>测试的结果如下：</p>
<p>




<img loading="lazy" decoding="async"
         src="https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/Page-92-Image-18.png"
         alt="../_images/Page-92-Image-18.png"
         title="Page-92-Image-18.png"
    /></p>
<p>我们终于看到多线程比非多线程跑的好的情况了，而且多线程只用了一半的时间。这给我们的启示是，多线程并不是一个标准。一般，我们将会将多线程放入一个队列中，将它们放到一边，执行其他任务。使用多线程执行同一个相同的任务有时候很有用，但用到的时候很少，除非需要大量处理数据输入。</p>
<h3 id="第四次测试">第四次测试</h3>
<p>在最后的测试中，我们使用 <code>urllib.request</code> 测试，这是一个Python模块，可以发送URL请求。此模块基于 <code>socket</code> ，使用C语言编写并且是线程安全的。</p>
<p>下面的代码尝试读取 <code>https://www.packpub.com</code> 的主页并且读取前1k的数据：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">def function_to_run():    import urllib.request    for i in range(10):        with urllib.request.urlopen(&#34;https://www.packtpub.com/&#34;)as f:            f.read(1024)
</code></pre></td></tr></table>
</div>
</div><p>运行结果如下：</p>
<p>




<img loading="lazy" decoding="async"
         src="https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/Page-93-Image-19.png"
         alt="../_images/Page-93-Image-19.png"
         title="Page-93-Image-19.png"
    /></p>
<p>可以看到，在 I/O 期间，GIL释放了。多线程执行比单线程快的多。鉴于大多数应用需要很多I/O操作，GIL并没有限制程序员在这方面使用多线程对程序进行性能优化。</p>
<h2 id="133-了解更多">13.3. 了解更多</h2>
<p>你应该记住，增加线程并不会提高应用启动的时间，但是可以支持并发。例如，一次性创建一个线程池，并重用worker会很有用。这可以让我们切分一个大的数据集，用同样的函数处理不同的部分（生产者消费者模型）。上面这些测试并不是并发应用的模型，只是尽量简单的测试。那么GIL会成为试图发挥多线程应用潜能的纯Python开发的瓶颈吗？是的。线程是编程语言的架构，CPython解释器是线程和操作系统的桥梁。这就是为什么Jython，IronPython没有GIL的原因（译者注：Pypy也没有），因为它不是必要的。</p>
</div>

            <div class="post" style="padding-top: 0">


<div class="post-share"><div class="share-link">
        <a class="share-icon share-facebook" href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="http://www.longtermbook.com/posts/%E5%9F%BA%E4%BA%8E%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%B9%B6%E8%A1%8C/" data-hashtag="python高性能编程"><span class="svg-social-icon icon-facebook"></span></a>
    </div><div class="share-link">
        <a class="share-icon share-whatsapp" href="javascript:void(0);" title="分享到 WhatsApp" data-sharer="whatsapp" data-url="http://www.longtermbook.com/posts/%E5%9F%BA%E4%BA%8E%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%B9%B6%E8%A1%8C/" data-title="基于线程的并行" data-web><span class="svg-social-icon icon-whatsapp"></span></a>
    </div><div class="share-link">
        <a class="share-icon share-line" href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="http://www.longtermbook.com/posts/%E5%9F%BA%E4%BA%8E%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%B9%B6%E8%A1%8C/" data-title="基于线程的并行"><span data-svg-src="/lib/simple-icons/icons/line.min.svg"></span></a>
</div><div class="share-link">
        <a class="share-icon share-evernote" href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="http://www.longtermbook.com/posts/%E5%9F%BA%E4%BA%8E%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%B9%B6%E8%A1%8C/" data-title="基于线程的并行"><span class="svg-social-icon icon-evernote"></span></a>
    </div></div>
<div class="post-tags"><a href="/tags/python%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/" class="tag">python高性能编程</a></div></div>
        </div>
    <div id="toc-final"></div>
    </article></div>

</main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.82.0">Hugo</a> 强力驱动 | 主题 - <a href="https://ublogger.netlify.app/?utm_source=http://www.longtermbook.com/&utm_medium=footer&utm_campaign=config&utm_term=2.0.1" target="_blank" title="uBlogger 2.0.1">uBlogger</a>
                </div><div class="footer-line"><i class="svg-icon icon-copyright"></i><span>2018 - 2022</span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="svg-icon icon-arrow-up"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="svg-icon icon-comments-fixed"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script src="/lib/autocomplete/autocomplete.min.js"></script><script src="/lib/lunr/lunr.min.js"></script><script src="/lib/lunr/lunr.stemmer.support.min.js"></script><script src="/lib/lunr/lunr.zh.min.js"></script><script src="/lib/clipboard/clipboard.min.js"></script><script src="/lib/sharer/sharer.min.js"></script><script src="/lib/katex/katex.min.js"></script><script src="/lib/katex/auto-render.min.js"></script><script src="/lib/katex/copy-tex.min.js"></script><script src="/lib/katex/mhchem.min.js"></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":20},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":30,"type":"lunr"}};</script><script src="/js/theme.min.js"></script></body>
</html>
