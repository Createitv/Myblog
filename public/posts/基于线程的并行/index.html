<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1"><meta name="robots" content="noodp"/><title>åŸºäºçº¿ç¨‹çš„å¹¶è¡Œ | ä¸”æ…¢</title><meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content=""/>
<meta name="twitter:title" content="åŸºäºçº¿ç¨‹çš„å¹¶è¡Œ"/>
<meta name="twitter:description" content="Createitv"/><meta name="Description" content="Createitv"><meta property="og:title" content="åŸºäºçº¿ç¨‹çš„å¹¶è¡Œ" />
<meta property="og:description" content="Createitv" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://www.longtermbook.com/posts/%E5%9F%BA%E4%BA%8E%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%B9%B6%E8%A1%8C/" /><meta property="og:image" content="http://www.longtermbook.com/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-27T11:06:07&#43;08:00" />
<meta property="article:modified_time" content="2021-07-27T11:06:07&#43;08:00" /><meta property="og:site_name" content="ä¸”æ…¢" />

<meta name="application-name" content="Createitv">
<meta name="apple-mobile-web-app-title" content="Createitv"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
        <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
        <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://www.longtermbook.com/posts/%E5%9F%BA%E4%BA%8E%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%B9%B6%E8%A1%8C/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "åŸºäºçº¿ç¨‹çš„å¹¶è¡Œ",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/www.longtermbook.com\/posts\/%E5%9F%BA%E4%BA%8E%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%B9%B6%E8%A1%8C\/"
        },"genre": "posts","keywords": "pythoné«˜æ€§èƒ½ç¼–ç¨‹","wordCount":  8482 ,
        "url": "http:\/\/www.longtermbook.com\/posts\/%E5%9F%BA%E4%BA%8E%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%B9%B6%E8%A1%8C\/","datePublished": "2021-07-27T11:06:07+08:00","dateModified": "2021-07-27T11:06:07+08:00","description": "Createitv"
    }
    </script><script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [{
            "@type": "ListItem",
            "position": 1,
            "name": "ä¸»é¡µ",
            "item": "http:\/\/www.longtermbook.com\/"
        },{
            "@type": "ListItem",
            "position": 2,
            "name": "python",
            "item": "http://www.longtermbook.com/categories/python/"
        },{
                "@type": "ListItem",
                "position": 3,
                "name": "åŸºäºçº¿ç¨‹çš„å¹¶è¡Œ"
            }]
    }
</script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="ä¸”æ…¢" class="header-logo logo-svg">ä¸”æ…¢</a>
        </div>
        <div class="menu">
            <nav>
                <ul class="menu-inner"><li>
                        <a class="menu-item" href="/posts/"> æ–‡ç«  </a>
                    </li><li>
                        <a class="menu-item" href="/tags/"> æ ‡ç­¾ </a>
                    </li><li>
                        <a class="menu-item" href="/categories/"> åˆ†ç±» </a>
                    </li></ul>
            </nav><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="æœç´¢">
                            <span class="svg-icon icon-search"></span>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="æ¸…ç©º">
                            <span class="svg-icon icon-cancel"></span>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <span class="svg-icon icon-loading"></span>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                    <span class="svg-icon icon-moon"></span>
                </a>
            </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="ä¸”æ…¢" class="header-logo">ä¸”æ…¢</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="æœç´¢">
                            <span class="svg-icon icon-search"></span>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="æ¸…ç©º">
                            <span class="svg-icon icon-cancel"></span>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <span class="svg-icon icon-loading"></span>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        å–æ¶ˆ
                    </a>
                </div><nav>
                <ul><li>
                        <a class="menu-item" href="/posts/" title="">æ–‡ç« </a>
                    </li><li>
                        <a class="menu-item" href="/tags/" title="">æ ‡ç­¾</a>
                    </li><li>
                        <a class="menu-item" href="/categories/" title="">åˆ†ç±»</a>
                    </li></ul>
            </nav>
            <a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                <span class="svg-icon icon-moon"></span>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div><main class="main">
<div class="container content-article  theme-classic"><div class="toc" id="toc-auto">
            <div class="toc-title">ç›®å½•</div>
            <div class="toc-content" id="toc-content-auto"></div>
        </div>

    <div class="header-post">

        

        
        <div class="post-title">

                <div class="post-all-meta">
                    <nav class="breadcrumbs">
    <ol>
        <li><a href="/">ä¸»é¡µ </a></li><li><a href="/categories/python/">python </a></li><li>åŸºäºçº¿ç¨‹çš„å¹¶è¡Œ</li>
    </ol>
</nav>
                    <h1 class="single-title flipInX">åŸºäºçº¿ç¨‹çš„å¹¶è¡Œ</h1><div class="post-meta">
                        <div class="post-meta-line"><span class="post-category">
                                <a href="/categories/python/"><i class="svg-icon icon-folder"></i>python</a>
                            </span><span class="post-meta-date">
                                <i class="svg-icon icon-clock"></i><time class="timeago" datetime="2021-07-27">2021-07-27</time>
                            </span><span class="post-meta-words">
                                <i class="svg-icon icon-pencil"></i>çº¦ 8482 å­—
                            </span>
                            <span class="post-meta-reading">
                                <i class="svg-icon icon-stopwatch"></i>é¢„è®¡é˜…è¯» 17 åˆ†é’Ÿ
                            </span>
                        </div>
                    </div>
                </div>

            </div>

            </div>

    <article class="single toc-start">

        <div class="content-block content-block-first content-block-position">

        <div class="post"><div class="details toc" id="toc-static"  data-kept="true">
                <div class="details-summary toc-title">
                    <span>ç›®å½•</span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-çº¿ç¨‹ä»‹ç»">1. çº¿ç¨‹ä»‹ç»</a></li>
    <li><a href="#2-pythonçº¿ç¨‹æ¨¡å—ä»‹ç»">2. pythonçº¿ç¨‹æ¨¡å—ä»‹ç»</a></li>
    <li><a href="#3-å®šä¹‰ä¸€ä¸ªpythonçº¿ç¨‹">3. å®šä¹‰ä¸€ä¸ªpythonçº¿ç¨‹</a>
      <ul>
        <li><a href="#31-ä»£ç ä¸¾ä¾‹">3.1 ä»£ç ä¸¾ä¾‹</a></li>
      </ul>
    </li>
    <li><a href="#4-ç¡®å®šçº¿ç¨‹è¿è¡ŒçŠ¶æ€">4. ç¡®å®šçº¿ç¨‹è¿è¡ŒçŠ¶æ€</a>
      <ul>
        <li><a href="#ç»™çº¿ç¨‹å‘½å">ç»™çº¿ç¨‹å‘½å</a></li>
        <li><a href="#è§£æ">è§£æ</a></li>
      </ul>
    </li>
    <li><a href="#5-è‡ªå·±åŠ¨æ‰‹å®ç°ä¸€ä¸ªçº¿ç¨‹">5. è‡ªå·±åŠ¨æ‰‹å®ç°ä¸€ä¸ªçº¿ç¨‹</a></li>
    <li><a href="#6-çº¿ç¨‹é”">6. çº¿ç¨‹é”ğŸ”’</a>
      <ul>
        <li><a href="#61-ä»£ç è§£é‡Š">6.1 ä»£ç è§£é‡Š</a></li>
        <li><a href="#62-ä»£ç è§£é‡Š">6.2 ä»£ç è§£é‡Š</a></li>
        <li><a href="#63-çº¿ç¨‹å¼Šç«¯">6.3. çº¿ç¨‹å¼Šç«¯</a></li>
      </ul>
    </li>
    <li><a href="#7-é€’å½’é”rlock">7. é€’å½’é”RLOCK</a></li>
    <li><a href="#8-ä¿¡å·é‡">8. ä¿¡å·é‡</a>
      <ul>
        <li><a href="#81-ä»£ç ">8.1 ä»£ç </a></li>
        <li><a href="#82-æ¶ˆè´¹è€…æ¨¡å‹çš„ä¿¡å·é‡ä½¿ç”¨">8.2 æ¶ˆè´¹è€…æ¨¡å‹çš„ä¿¡å·é‡ä½¿ç”¨</a></li>
      </ul>
    </li>
    <li><a href="#9-æ¡ä»¶çº¿ç¨‹è®¾ç½®">9. æ¡ä»¶çº¿ç¨‹è®¾ç½®</a>
      <ul>
        <li><a href="#91-ä»£ç ">9.1 ä»£ç </a></li>
      </ul>
    </li>
    <li><a href="#10-äº‹ä»¶è¿›è¡Œçº¿ç¨‹åŒæ­¥">10. äº‹ä»¶è¿›è¡Œçº¿ç¨‹åŒæ­¥</a>
      <ul>
        <li><a href="#101-ä»£ç ">10.1 ä»£ç </a></li>
      </ul>
    </li>
    <li><a href="#11-çº¿ç¨‹ä¸­çš„withè¯­å¥">11. çº¿ç¨‹ä¸­çš„withè¯­å¥</a>
      <ul>
        <li><a href="#111-ä»£ç ">11.1 ä»£ç </a></li>
        <li><a href="#102-è§£é‡Š">10.2 è§£é‡Š</a></li>
      </ul>
    </li>
    <li><a href="#12-ä½¿ç”¨é˜Ÿåˆ—è¿›è¡Œçº¿ç¨‹é€šä¿¡">12. ä½¿ç”¨é˜Ÿåˆ—è¿›è¡Œçº¿ç¨‹é€šä¿¡</a>
      <ul>
        <li><a href="#122-ä»£ç ">12.2 ä»£ç </a></li>
        <li><a href="#122-è§£é‡Š">12.2 è§£é‡Š</a></li>
      </ul>
    </li>
    <li><a href="#13-è¯„ä¼°å¤šçº¿ç¨‹åº”ç”¨çš„æ€§èƒ½">13. è¯„ä¼°å¤šçº¿ç¨‹åº”ç”¨çš„æ€§èƒ½</a>
      <ul>
        <li><a href="#131-ä»£ç ">13.1 ä»£ç </a></li>
      </ul>
    </li>
    <li><a href="#132-è§£é‡Š">13.2. è§£é‡Š</a>
      <ul>
        <li><a href="#ç¬¬ä¸€æ¬¡æµ‹è¯•">ç¬¬ä¸€æ¬¡æµ‹è¯•</a></li>
        <li><a href="#ç¬¬äºŒæ¬¡æµ‹è¯•">ç¬¬äºŒæ¬¡æµ‹è¯•</a></li>
        <li><a href="#ç¬¬ä¸‰æ¬¡æµ‹è¯•">ç¬¬ä¸‰æ¬¡æµ‹è¯•</a></li>
        <li><a href="#ç¬¬å››æ¬¡æµ‹è¯•">ç¬¬å››æ¬¡æµ‹è¯•</a></li>
      </ul>
    </li>
    <li><a href="#133-äº†è§£æ›´å¤š">13.3. äº†è§£æ›´å¤š</a></li>
  </ul>
</nav></div>
            </div><h2 id="1-çº¿ç¨‹ä»‹ç»">1. çº¿ç¨‹ä»‹ç»</h2>
<p>ç›®å‰ï¼Œåœ¨è½¯ä»¶åº”ç”¨ä¸­ä½¿ç”¨æœ€å¹¿æ³›çš„å¹¶å‘ç¼–ç¨‹èŒƒä¾‹æ˜¯å¤šçº¿ç¨‹ã€‚é€šå¸¸ï¼Œä¸€ä¸ªåº”ç”¨æœ‰ä¸€ä¸ªè¿›ç¨‹ï¼Œåˆ†æˆå¤šä¸ªç‹¬ç«‹çš„çº¿ç¨‹ï¼Œå¹¶è¡Œè¿è¡Œã€äº’ç›¸é…åˆï¼Œæ‰§è¡Œä¸åŒç±»å‹çš„ä»»åŠ¡ã€‚</p>
<p>ä¸»è¦ç‰¹ç‚¹ï¼š</p>
<ul>
<li>çº¿ç¨‹æ˜¯ç‹¬ç«‹çš„å¤„ç†æµç¨‹ï¼Œå¯ä»¥å’Œç³»ç»Ÿçš„å…¶ä»–çº¿ç¨‹å¹¶è¡Œæˆ–å¹¶å‘åœ°æ‰§è¡Œã€‚</li>
<li>å¤šçº¿ç¨‹å¯ä»¥å…±äº«æ•°æ®å’Œèµ„æºï¼Œåˆ©ç”¨æ‰€è°“çš„å…±äº«å†…å­˜ç©ºé—´ã€‚</li>
<li>åŒä¸€è¿›ç¨‹çš„å¤šä¸ªä¸åŒçš„çº¿ç¨‹å¯ä»¥å…±äº«ç›¸åŒçš„èµ„æºã€‚ç›¸æ¯”è€Œè¨€ï¼Œè¿›ç¨‹ä¹‹é—´ä¸ä¼šå…±äº«èµ„æºã€‚</li>
</ul>
<p>æ¯ä¸€ä¸ªçº¿ç¨‹åŸºæœ¬ä¸ŠåŒ…å«3ä¸ªå…ƒç´ ï¼šç¨‹åºè®¡æ•°å™¨ï¼Œå¯„å­˜å™¨å’Œæ ˆã€‚ä¸åŒä¸€è¿›ç¨‹çš„å…¶ä»–çº¿ç¨‹å…±äº«çš„èµ„æºåŸºæœ¬ä¸ŠåŒ…æ‹¬æ•°æ®å’Œç³»ç»Ÿèµ„æºã€‚æ¯ä¸€ä¸ªçº¿ç¨‹ä¹Ÿæœ‰è‡ªå·±çš„è¿è¡ŒçŠ¶æ€ï¼Œå¯ä»¥å’Œå…¶ä»–çº¿ç¨‹åŒæ­¥ï¼Œè¿™ç‚¹å’Œè¿›ç¨‹ä¸€æ ·ã€‚çº¿ç¨‹çš„çŠ¶æ€å¤§ä½“ä¸Šå¯ä»¥åˆ†ä¸º<strong>ready</strong>,<strong>running</strong>,<strong>blocked</strong>ã€‚</p>
<h2 id="2-pythonçº¿ç¨‹æ¨¡å—ä»‹ç»">2. pythonçº¿ç¨‹æ¨¡å—ä»‹ç»</h2>
<p>Pythoné€šè¿‡æ ‡å‡†åº“çš„ <code>threading</code> æ¨¡å—æ¥ç®¡ç†çº¿ç¨‹ã€‚è¿™ä¸ªæ¨¡å—æä¾›äº†å¾ˆå¤šä¸é”™çš„ç‰¹æ€§ï¼Œè®©çº¿ç¨‹å˜å¾—æ— æ¯”ç®€å•ã€‚å®é™…ä¸Šï¼Œçº¿ç¨‹æ¨¡å—æä¾›äº†å‡ ç§åŒæ—¶è¿è¡Œçš„æœºåˆ¶ï¼Œå®ç°èµ·æ¥éå¸¸ç®€å•ã€‚</p>
<p>çº¿ç¨‹æ¨¡å—çš„ä¸»è¦ç»„ä»¶å¦‚ä¸‹ï¼š</p>
<ul>
<li>çº¿ç¨‹å¯¹è±¡</li>
<li>Lockå¯¹è±¡</li>
<li>RLockå¯¹è±¡</li>
<li>ä¿¡å·å¯¹è±¡</li>
<li>æ¡ä»¶å¯¹è±¡</li>
<li>äº‹ä»¶å¯¹è±¡</li>
</ul>
<h2 id="3-å®šä¹‰ä¸€ä¸ªpythonçº¿ç¨‹">3. å®šä¹‰ä¸€ä¸ªpythonçº¿ç¨‹</h2>
<p>ä½¿ç”¨çº¿ç¨‹æœ€ç®€å•çš„ä¸€ä¸ªæ–¹æ³•æ˜¯ï¼Œç”¨ä¸€ä¸ªç›®æ ‡å‡½æ•°å®ä¾‹åŒ–ä¸€ä¸ªThreadç„¶åè°ƒç”¨ <code>start()</code> æ–¹æ³•å¯åŠ¨å®ƒã€‚Pythonçš„threadingæ¨¡å—æä¾›äº† <code>Thread()</code> æ–¹æ³•åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è¿è¡Œå‡½æ•°æˆ–å¤„ç†è¿‡ç¨‹ç­‰ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                       <span class="n">target</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                       <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                       <span class="n">args</span><span class="o">=</span><span class="p">(),</span>
                       <span class="n">kwargs</span><span class="o">=</span><span class="p">{})</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢çš„ä»£ç ä¸­ï¼š</p>
<ul>
<li><code>group</code>: ä¸€èˆ¬è®¾ç½®ä¸º <code>None</code> ï¼Œè¿™æ˜¯ä¸ºä»¥åçš„ä¸€äº›ç‰¹æ€§é¢„ç•™çš„</li>
<li><code>target</code>: å½“çº¿ç¨‹å¯åŠ¨çš„æ—¶å€™è¦æ‰§è¡Œçš„å‡½æ•°</li>
<li><code>name</code>: çº¿ç¨‹çš„åå­—ï¼Œé»˜è®¤ä¼šåˆ†é…ä¸€ä¸ªå”¯ä¸€åå­— <code>Thread-N</code></li>
<li><code>args</code>: ä¼ é€’ç»™ <code>target</code> çš„å‚æ•°ï¼Œè¦ä½¿ç”¨tupleç±»å‹</li>
<li><code>kwargs</code>: åŒä¸Šï¼Œä½¿ç”¨å­—å…¸ç±»å‹dict</li>
</ul>
<p>åˆ›å»ºçº¿ç¨‹çš„æ–¹æ³•éå¸¸å®ç”¨ï¼Œé€šè¿‡<code>target</code>å‚æ•°<code>arg</code>å’Œ<code>kwarg</code>å‘Šè¯‰çº¿ç¨‹åº”è¯¥åšä»€ä¹ˆã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­ä¼ é€’ä¸€ä¸ªæ•°å­—ç»™çº¿ç¨‹ï¼ˆè¿™ä¸ªæ•°å­—æ­£å¥½ç­‰äºçº¿ç¨‹å·ç ï¼‰ï¼Œç›®æ ‡å‡½æ•°ä¼šæ‰“å°å‡ºè¿™ä¸ªæ•°å­—ã€‚</p>
<h3 id="31-ä»£ç ä¸¾ä¾‹">3.1 ä»£ç ä¸¾ä¾‹</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">threading</span>

<span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="k">print</span> <span class="p">(</span><span class="s2">&#34;function called by thread </span><span class="si">%i</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">return</span>

<span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
  	<span class="c1"># çº¿ç¨‹å¯¹è±¡</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">function</span> <span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="c1"># åŠ å…¥ä¸»çº¿ç¨‹é˜Ÿåˆ—</span>
    <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>è¾“å‡º</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"> <span class="err">âœ”</span>  <span class="n">python</span> <span class="o">-</span><span class="n">u</span> <span class="n">thread_simple</span><span class="o">.</span><span class="n">py</span>
<span class="n">function</span> <span class="n">called</span> <span class="n">by</span> <span class="n">thread</span> <span class="mi">0</span>

<span class="n">function</span> <span class="n">called</span> <span class="n">by</span> <span class="n">thread</span> <span class="mi">1</span>

<span class="n">function</span> <span class="n">called</span> <span class="n">by</span> <span class="n">thread</span> <span class="mi">2</span>

<span class="n">function</span> <span class="n">called</span> <span class="n">by</span> <span class="n">thread</span> <span class="mi">3</span>

<span class="n">function</span> <span class="n">called</span> <span class="n">by</span> <span class="n">thread</span> <span class="mi">4</span>
</code></pre></td></tr></table>
</div>
</div><p>å¯¼å…¥å†…ç½®threadingæ¨¡å—ï¼Œç®€å•åœ°ä½¿ç”¨pythonå‘½ä»¤å°±å¯ä»¥äº†ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">import threading
</code></pre></td></tr></table>
</div>
</div><p>åœ¨ä¸»ç¨‹åºä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ç›®æ ‡å‡½æ•° <code>function</code> åˆå§‹åŒ–äº†ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ <code>Thread</code> ã€‚åŒæ—¶è¿˜ä¼ å…¥äº†ç”¨äºæ‰“å°çš„ä¸€ä¸ªå‚æ•°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">t = threading.Thread(target=function , args=(i, ))
</code></pre></td></tr></table>
</div>
</div><p>çº¿ç¨‹è¢«åˆ›å»ºä¹‹åå¹¶ä¸ä¼šé©¬ä¸Šè¿è¡Œï¼Œéœ€è¦æ‰‹åŠ¨è°ƒç”¨ <code>start()</code> ï¼Œ <code>join()</code> è®©è°ƒç”¨å®ƒçš„çº¿ç¨‹ä¸€ç›´ç­‰å¾…ç›´åˆ°æ‰§è¡Œç»“æŸï¼ˆå³é˜»å¡è°ƒç”¨å®ƒçš„ä¸»çº¿ç¨‹ï¼Œ <code>t</code> çº¿ç¨‹æ‰§è¡Œç»“æŸï¼Œä¸»çº¿ç¨‹æ‰ä¼šç»§ç»­æ‰§è¡Œï¼‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">t.start()
t.join()
</code></pre></td></tr></table>
</div>
</div><h2 id="4-ç¡®å®šçº¿ç¨‹è¿è¡ŒçŠ¶æ€">4. ç¡®å®šçº¿ç¨‹è¿è¡ŒçŠ¶æ€</h2>
<p>threadingæ¨¡å—æä¾›äº†ä¸€äº›æ¯”è¾ƒå®ç”¨çš„æ–¹æ³•æˆ–è€…å±æ€§</p>
<p>




<img loading="lazy" decoding="async"
         src="https://typora-1300715298.cos.ap-shanghai.myqcloud.com/uPic/image-20210624092547213.png"
         alt="image-20210624092547213"
         title="image-20210624092547213.png"
    /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                    <span class="n">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1">-</span><span class="si">%(levelname)s</span><span class="s1">-</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">sites</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;&lt;https://www.yahoo.com/&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;http://www.cnn.com&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;http://www.python.org&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;http://www.jython.org&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;http://www.pypy.org&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;http://www.perl.org&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;http://www.cisco.com&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;http://www.facebook.com&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;http://www.twitter.com&gt;&#39;</span><span class="p">,</span>
    <span class="s2">&#34;&lt;https://www.youtube.com/&gt;&#34;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;http://arstechnica.com/&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;http://www.reuters.com/&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;http://abcnews.go.com/&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;http://www.cnbc.com/&gt;&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">getHtml</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>

<span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
    <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">getHtml</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">url</span><span class="p">,))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Process ID: {os.getpid()}&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;Main thread {threading.main_thread()}&#34;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Thread Count: {threading.active_count()}&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threading</span><span class="o">.</span><span class="n">enumerate</span><span class="p">():</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<p>




<img loading="lazy" decoding="async"
         src="https://typora-1300715298.cos.ap-shanghai.myqcloud.com/uPic/image-20210624092630425.png"
         alt="image-20210624092630425"
         title="image-20210624092630425.png"
    /></p>
<h3 id="ç»™çº¿ç¨‹å‘½å">ç»™çº¿ç¨‹å‘½å</h3>
<p>ä½¿ç”¨å‚æ•°æ¥ç¡®è®¤æˆ–å‘½åçº¿ç¨‹æ˜¯ç¬¨æ‹™ä¸”æ²¡æœ‰å¿…è¦çš„ã€‚æ¯ä¸€ä¸ª <code>Thread</code> å®ä¾‹åˆ›å»ºçš„æ—¶å€™éƒ½æœ‰ä¸€ä¸ªå¸¦é»˜è®¤å€¼çš„åå­—ï¼Œå¹¶ä¸”å¯ä»¥ä¿®æ”¹ã€‚åœ¨æœåŠ¡ç«¯é€šå¸¸ä¸€ä¸ªæœåŠ¡è¿›ç¨‹éƒ½æœ‰å¤šä¸ªçº¿ç¨‹æœåŠ¡ï¼Œè´Ÿè´£ä¸åŒçš„æ“ä½œï¼Œè¿™æ—¶å€™å‘½åçº¿ç¨‹æ˜¯å¾ˆå®ç”¨çš„</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">first_function</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">currentThread</span><span class="p">()</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39; is Starting &#39;</span><span class="p">))</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">print</span> <span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">currentThread</span><span class="p">()</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39; is Exiting &#39;</span><span class="p">))</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">second_function</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">currentThread</span><span class="p">()</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39; is Starting &#39;</span><span class="p">))</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">print</span> <span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">currentThread</span><span class="p">()</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39; is Exiting &#39;</span><span class="p">))</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">third_function</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">currentThread</span><span class="p">()</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39; is Starting &#39;</span><span class="p">))</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">currentThread</span><span class="p">()</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39; is Exiting &#39;</span><span class="p">))</span>
    <span class="k">return</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;first_function&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">first_function</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;second_function&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">second_function</span><span class="p">)</span>
    <span class="n">t3</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;third_function&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">third_function</span><span class="p">)</span>
    <span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t3</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœ:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"> <span class="err">âœ”</span>  <span class="n">python</span> <span class="o">-</span><span class="n">u</span> <span class="n">thread_simple</span><span class="o">.</span><span class="n">pyfirst_function</span> <span class="ow">is</span> <span class="n">Starting</span> <span class="n">second_function</span> <span class="ow">is</span> <span class="n">Starting</span> <span class="n">third_function</span> <span class="ow">is</span> <span class="n">Starting</span> <span class="n">first_function</span> <span class="ow">is</span> <span class="n">Exiting</span> <span class="n">second_function</span> <span class="ow">is</span> <span class="n">Exiting</span> <span class="n">third_function</span> <span class="ow">is</span> <span class="n">Exiting</span> 
</code></pre></td></tr></table>
</div>
</div><h3 id="è§£æ">è§£æ</h3>
<p>æˆ‘ä»¬ä½¿ç”¨ç›®æ ‡å‡½æ•°å®ä¾‹åŒ–çº¿ç¨‹ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¼ å…¥ <code>name</code> å‚æ•°ä½œä¸ºçº¿ç¨‹çš„åå­—ï¼Œå¦‚æœä¸ä¼ è¿™ä¸ªå‚æ•°ï¼Œå°†ä½¿ç”¨é»˜è®¤çš„å‚æ•°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">t1 = threading.Thread(name=&#39;first_function&#39;, target=first_function)t2 = threading.Thread(name=&#39;second_function&#39;, target=second_function)t3 = threading.Thread(target=third_function)
</code></pre></td></tr></table>
</div>
</div><p>ï¼ˆè¯‘è€…æ³¨ï¼šè¿™é‡Œçš„ä»£ç å’Œä¸Šé¢çš„ä¸ä¸€æ ·ï¼Œå¯èƒ½ä½œè€…æœ¬æ„æ˜¯ç¬¬ä¸‰ä¸ªçº¿ç¨‹ä¸åŠ å‚æ•°æ¥æµ‹è¯•é»˜è®¤çš„è¡Œä¸ºï¼Œå¦‚æœæ”¹ä¸ºè¿™é‡Œçš„ä»£ç ï¼Œé‚£ä¹ˆçº¿ç¨‹3å°†ä¼šè¾“å‡ºçš„æ˜¯ <code>Thread-1 is Starting</code> ä»¥åŠ <code>Thread-1 is Exiting</code> ï¼Œè¯»è€…å¯ä»¥è‡ªè¡Œå°è¯•ï¼‰</p>
<p>æœ€åè°ƒç”¨ <code>start()</code> å’Œ <code>join()</code> å¯åŠ¨å®ƒä»¬ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">t1.start()t2.start()t3.start()t1.join()t2.join()t3.join()
</code></pre></td></tr></table>
</div>
</div><h2 id="5-è‡ªå·±åŠ¨æ‰‹å®ç°ä¸€ä¸ªçº¿ç¨‹">5. è‡ªå·±åŠ¨æ‰‹å®ç°ä¸€ä¸ªçº¿ç¨‹</h2>
<p>ä½¿ç”¨threadingæ¨¡å—å®ç°ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œéœ€è¦ä¸‹é¢3æ­¥ï¼š</p>
<ul>
<li>å®šä¹‰ä¸€ä¸ª <code>Thread</code> ç±»çš„å­ç±»</li>
<li>é‡å†™ <code>__init__(self [,args])</code> æ–¹æ³•ï¼Œå¯ä»¥æ·»åŠ é¢å¤–çš„å‚æ•°</li>
<li>æœ€åï¼Œéœ€è¦é‡å†™ <code>run(self, [,args])</code> æ–¹æ³•æ¥å®ç°çº¿ç¨‹è¦åšçš„äº‹æƒ…</li>
</ul>
<p>å½“ä½ åˆ›å»ºäº†æ–°çš„ <code>Thread</code> å­ç±»çš„æ—¶å€™ï¼Œä½ å¯ä»¥å®ä¾‹åŒ–è¿™ä¸ªç±»ï¼Œè°ƒç”¨ <code>start()</code> æ–¹æ³•æ¥å¯åŠ¨å®ƒã€‚çº¿ç¨‹å¯åŠ¨ä¹‹åå°†ä¼šæ‰§è¡Œ <code>run()</code> æ–¹æ³•ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">threadingimport</span> <span class="nn">timeexitFlag</span> <span class="o">=</span> <span class="mi">0</span><span class="k">class</span> <span class="nc">myThread</span> <span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threadID</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">counter</span><span class="p">):</span>        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>        <span class="bp">self</span><span class="o">.</span><span class="n">threadID</span> <span class="o">=</span> <span class="n">threadID</span>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Starting &#34;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>        <span class="n">print_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Exiting &#34;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="k">def</span> <span class="nf">print_time</span><span class="p">(</span><span class="n">threadName</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">counter</span><span class="p">):</span>    <span class="k">while</span> <span class="n">counter</span><span class="p">:</span>        <span class="k">if</span> <span class="n">exitFlag</span><span class="p">:</span>            <span class="c1"># è¯‘è€…æ³¨ï¼šåŸä¹¦ä¸­ä½¿ç”¨çš„threadï¼Œä½†æ˜¯Python3ä¸­å·²ç»ä¸èƒ½ä½¿ç”¨threadï¼Œä»¥_threadå–ä»£ï¼Œå› æ­¤åº”è¯¥            # import _thread            # _thread.exit()            thread.exit()        time.sleep(delay)        print(&#34;%s: %s&#34; % (threadName, time.ctime(time.time())))        counter -= 1# Create new threadsthread1 = myThread(1, &#34;Thread-1&#34;, 1)thread2 = myThread(2, &#34;Thread-2&#34;, 2)# Start new Threadsthread1.start()thread2.start()# ä»¥ä¸‹ä¸¤è¡Œä¸ºè¯‘è€…æ·»åŠ ï¼Œå¦‚æœè¦è·å¾—å’Œå›¾ç‰‡ç›¸åŒçš„ç»“æœï¼Œ# ä¸‹é¢ä¸¤è¡Œæ˜¯å¿…é¡»çš„ã€‚ç–‘ä¼¼åŸä½œè€…çš„ç–æ¼thread1.join()thread2.join()print(&#34;Exiting Main Thread&#34;)</span>
</code></pre></td></tr></table>
</div>
</div><p>ç»“æœï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"> <span class="err">âœ”</span>  <span class="n">python</span> <span class="o">-</span><span class="n">u</span> <span class="n">thread_run</span><span class="o">.</span><span class="n">pyStarting</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">1</span><span class="n">Starting</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span><span class="n">Thread</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Jun</span> <span class="mi">24</span> <span class="mi">09</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">43</span> <span class="mi">2021</span><span class="n">Thread</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Jun</span> <span class="mi">24</span> <span class="mi">09</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">44</span> <span class="mi">2021</span><span class="n">Thread</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Jun</span> <span class="mi">24</span> <span class="mi">09</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">44</span> <span class="mi">2021</span><span class="n">Thread</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Jun</span> <span class="mi">24</span> <span class="mi">09</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">45</span> <span class="mi">2021</span><span class="n">Thread</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Jun</span> <span class="mi">24</span> <span class="mi">09</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">46</span> <span class="mi">2021</span><span class="n">Thread</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Jun</span> <span class="mi">24</span> <span class="mi">09</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">46</span> <span class="mi">2021</span><span class="n">Thread</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Jun</span> <span class="mi">24</span> <span class="mi">09</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">47</span> <span class="mi">2021</span><span class="n">Exiting</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">1</span><span class="n">Thread</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Jun</span> <span class="mi">24</span> <span class="mi">09</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">48</span> <span class="mi">2021</span><span class="n">Thread</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Jun</span> <span class="mi">24</span> <span class="mi">09</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">50</span> <span class="mi">2021</span><span class="n">Thread</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Jun</span> <span class="mi">24</span> <span class="mi">09</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">52</span> <span class="mi">2021</span><span class="n">Exiting</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span><span class="n">Exiting</span> <span class="n">Main</span> <span class="n">Thread</span>
</code></pre></td></tr></table>
</div>
</div><p>è§£é‡Šï¼š</p>
<p><code>threading</code> æ¨¡å—æ˜¯åˆ›å»ºå’Œç®¡ç†çº¿ç¨‹çš„é¦–é€‰å½¢å¼ã€‚æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½é€šè¿‡ä¸€ä¸ªç»§æ‰¿ <code>Thread</code> ç±»ï¼Œé‡å†™ <code>run()</code> æ–¹æ³•æ¥å®ç°é€»è¾‘ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯çº¿ç¨‹çš„å…¥å£ã€‚åœ¨ä¸»ç¨‹åºä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†å¤šä¸ª <code>myThread</code> çš„ç±»å‹å®ä¾‹ï¼Œç„¶åæ‰§è¡Œ <code>start()</code> æ–¹æ³•å¯åŠ¨å®ƒä»¬ã€‚è°ƒç”¨ <code>Thread.__init__</code> æ„é€ å™¨æ–¹æ³•æ˜¯å¿…é¡»çš„ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥ç»™çº¿ç¨‹å®šä¹‰ä¸€äº›åå­—æˆ–åˆ†ç»„ä¹‹ç±»çš„å±æ€§ã€‚è°ƒç”¨ <code>start()</code> ä¹‹åçº¿ç¨‹å˜ä¸ºæ´»è·ƒçŠ¶æ€ï¼Œå¹¶ä¸”æŒç»­ç›´åˆ° <code>run()</code> ç»“æŸï¼Œæˆ–è€…ä¸­é—´å‡ºç°å¼‚å¸¸ã€‚æ‰€æœ‰çš„çº¿ç¨‹éƒ½æ‰§è¡Œå®Œæˆä¹‹åï¼Œç¨‹åºç»“æŸã€‚</p>
<p><code>join()</code> å‘½ä»¤æ§åˆ¶ä¸»çº¿ç¨‹çš„ç»ˆæ­¢ã€‚</p>
<h2 id="6-çº¿ç¨‹é”">6. çº¿ç¨‹é”ğŸ”’</h2>
<p>å½“ä¸¤ä¸ªæˆ–ä»¥ä¸Šå¯¹å…±äº«å†…å­˜çš„æ“ä½œå‘ç”Ÿåœ¨å¹¶å‘çº¿ç¨‹ä¸­ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªå¯ä»¥æ”¹å˜æ•°æ®ï¼Œåˆæ²¡æœ‰åŒæ­¥æœºåˆ¶çš„æ¡ä»¶ä¸‹ï¼Œå°±ä¼šäº§ç”Ÿç«äº‰æ¡ä»¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ‰§è¡Œæ— æ•ˆä»£ç ã€bugã€æˆ–å¼‚å¸¸è¡Œä¸ºã€‚</p>
<p>ç«äº‰æ¡ä»¶æœ€ç®€å•çš„è§£å†³æ–¹æ³•æ˜¯ä½¿ç”¨é”ã€‚é”çš„æ“ä½œéå¸¸ç®€å•ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦è®¿é—®éƒ¨åˆ†å…±äº«å†…å­˜æ—¶ï¼Œå®ƒå¿…é¡»å…ˆè·å¾—é”æ‰èƒ½è®¿é—®ã€‚æ­¤çº¿ç¨‹å¯¹è¿™éƒ¨åˆ†å…±äº«èµ„æºä½¿ç”¨å®Œæˆä¹‹åï¼Œè¯¥çº¿ç¨‹å¿…é¡»é‡Šæ”¾é”ï¼Œç„¶åå…¶ä»–çº¿ç¨‹å°±å¯ä»¥æ‹¿åˆ°è¿™ä¸ªé”å¹¶è®¿é—®è¿™éƒ¨åˆ†èµ„æºäº†ã€‚</p>
<p>ç„¶è€Œï¼Œåœ¨å®é™…ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°è¿™ä¸ªæ–¹æ³•ç»å¸¸ä¼šå¯¼è‡´ä¸€ç§ç³Ÿç³•çš„æ­»é”ç°è±¡ã€‚å½“ä¸åŒçš„çº¿ç¨‹è¦æ±‚å¾—åˆ°ä¸€ä¸ªé”æ—¶ï¼Œæ­»é”å°±ä¼šå‘ç”Ÿï¼Œè¿™æ—¶ç¨‹åºä¸å¯èƒ½ç»§ç»­æ‰§è¡Œï¼Œå› ä¸ºå®ƒä»¬äº’ç›¸æ‹¿ç€å¯¹æ–¹éœ€è¦çš„é”ã€‚ä½¿ç”¨é”æ¥è§£å†³åŒæ­¥é—®é¢˜æ˜¯ä¸€ä¸ªå¯è¡Œå´å­˜åœ¨æ½œåœ¨é—®é¢˜çš„æ–¹æ¡ˆã€‚</p>
<h3 id="61-ä»£ç è§£é‡Š">6.1 ä»£ç è§£é‡Š</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># -*- coding: utf-8 -*-import threadingshared_resource_with_lock = 0shared_resource_with_no_lock = 0COUNT = 100000shared_resource_lock = threading.Lock()# æœ‰é”çš„æƒ…å†µdef increment_with_lock():    global shared_resource_with_lock    for i in range(COUNT):        shared_resource_lock.acquire()        shared_resource_with_lock += 1        shared_resource_lock.release()def decrement_with_lock():    global shared_resource_with_lock    for i in range(COUNT):        shared_resource_lock.acquire()        shared_resource_with_lock -= 1        shared_resource_lock.release()# æ²¡æœ‰é”çš„æƒ…å†µdef increment_without_lock():    global shared_resource_with_no_lock    for i in range(COUNT):        shared_resource_with_no_lock += 1def decrement_without_lock():    global shared_resource_with_no_lock    for i in range(COUNT):        shared_resource_with_no_lock -= 1if __name__ == &#34;__main__&#34;:    t1 = threading.Thread(target=increment_with_lock)    t2 = threading.Thread(target=decrement_with_lock)    t3 = threading.Thread(target=increment_without_lock)    t4 = threading.Thread(target=decrement_without_lock)    t1.start()    t2.start()    t3.start()    t4.start()    t1.join()    t2.join()    t3.join()    t4.join()    print (&#34;the value of shared variable with lock management is %s&#34; % shared_resource_with_lock)    print (&#34;the value of shared variable with race condition is %s&#34; % shared_resource_with_no_lock)</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"> <span class="err">âœ”</span>  <span class="n">python</span> <span class="o">-</span><span class="n">u</span> <span class="n">thread_lock</span><span class="o">.</span><span class="n">pythe</span> <span class="n">value</span> <span class="n">of</span> <span class="n">shared</span> <span class="n">variable</span> <span class="k">with</span> <span class="n">lock</span> <span class="n">management</span> <span class="ow">is</span> <span class="mi">0</span><span class="n">the</span> <span class="n">value</span> <span class="n">of</span> <span class="n">shared</span> <span class="n">variable</span> <span class="k">with</span> <span class="n">race</span> <span class="n">condition</span> <span class="ow">is</span> <span class="mi">67058</span>
</code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœæœ‰é”æ¥ç®¡ç†çº¿ç¨‹çš„è¯ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°æ­£ç¡®çš„ç»“æœã€‚è¿™é‡Œè¦æ³¨æ„ï¼Œæ²¡æœ‰é”çš„æƒ…å†µä¸‹å¹¶ä¸ä¸€å®šä¼šå¾—åˆ°é”™è¯¯çš„ç»“æœï¼Œä½†æ˜¯é‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œæ€»ä¼šå‡ºç°é”™è¯¯çš„ç»“æœã€‚è€Œæœ‰é”çš„æƒ…å†µç»“æœæ€»ä¼šæ˜¯æ­£ç¡®çš„ã€‚</p>
<h3 id="62-ä»£ç è§£é‡Š">6.2 ä»£ç è§£é‡Š</h3>
<p>åœ¨ä¸»ç¨‹åºä¸­ï¼Œæˆ‘ä»¬æœ‰ä»¥ä¸‹æ­¥éª¤ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">t1 = threading.Thread(target=increment_with_lock)t2 = threading.Thread(target=decrement_with_lock)
</code></pre></td></tr></table>
</div>
</div><p>å¯åŠ¨çº¿ç¨‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">t1.start()t2.start()
</code></pre></td></tr></table>
</div>
</div><p>ç„¶åé˜»å¡ä¸»çº¿ç¨‹ç›´åˆ°æ‰€æœ‰çº¿ç¨‹å®Œæˆï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">t1.join()t2.join()
</code></pre></td></tr></table>
</div>
</div><p>åœ¨ <code>increment_with_lock()</code> å‡½æ•°å’Œ <code>decrement_with_lock()</code> å‡½æ•°ä¸­ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä½¿ç”¨äº†lockè¯­å¥ã€‚å½“ä½ éœ€è¦ä½¿ç”¨èµ„æºçš„æ—¶å€™ï¼Œè°ƒç”¨ <code>acquire()</code> æ‹¿åˆ°é”ï¼ˆå¦‚æœé”æš‚æ—¶ä¸å¯ç”¨ï¼Œä¼šä¸€ç›´ç­‰å¾…ç›´åˆ°æ‹¿åˆ°ï¼‰ï¼Œæœ€åè°ƒç”¨ <code>release()</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">shared_resource_lock.acquire()shared_resource_with_lock -= 1shared_resource_lock.release()
</code></pre></td></tr></table>
</div>
</div><p>è®©æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ï¼š</p>
<ul>
<li>é”æœ‰ä¸¤ç§çŠ¶æ€ï¼š lockedï¼ˆè¢«æŸä¸€çº¿ç¨‹æ‹¿åˆ°ï¼‰å’Œunlockedï¼ˆå¯ç”¨çŠ¶æ€ï¼‰</li>
<li>æˆ‘ä»¬æœ‰ä¸¤ä¸ªæ–¹æ³•æ¥æ“ä½œé”ï¼š <code>acquire()</code> å’Œ <code>release()</code></li>
</ul>
<p>éœ€è¦éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š</p>
<ul>
<li>å¦‚æœçŠ¶æ€æ˜¯unlockedï¼Œ å¯ä»¥è°ƒç”¨ <code>acquire()</code> å°†çŠ¶æ€æ”¹ä¸ºlocked</li>
<li>å¦‚æœçŠ¶æ€æ˜¯lockedï¼Œ <code>acquire()</code> ä¼šè¢«blockç›´åˆ°å¦ä¸€çº¿ç¨‹è°ƒç”¨ <code>release()</code> é‡Šæ”¾é”</li>
<li>å¦‚æœçŠ¶æ€æ˜¯unlockedï¼Œ è°ƒç”¨ <code>release()</code> å°†å¯¼è‡´ <code>RuntimError</code> å¼‚å¸¸</li>
<li>å¦‚æœçŠ¶æ€æ˜¯lockedï¼Œ å¯ä»¥è°ƒç”¨ <code>release()</code> å°†çŠ¶æ€æ”¹ä¸ºunlocked</li>
</ul>
<h3 id="63-çº¿ç¨‹å¼Šç«¯">6.3. çº¿ç¨‹å¼Šç«¯</h3>
<p>å°½ç®¡ç†è®ºä¸Šè¡Œå¾—é€šï¼Œä½†æ˜¯é”çš„ç­–ç•¥ä¸ä»…ä¼šå¯¼è‡´æœ‰å®³çš„åƒµæŒå±€é¢ã€‚è¿˜ä¼šå¯¹åº”ç”¨ç¨‹åºçš„å…¶ä»–æ–¹é¢äº§ç”Ÿè´Ÿé¢å½±å“ã€‚è¿™æ˜¯ä¸€ç§ä¿å®ˆçš„æ–¹æ³•ï¼Œç»å¸¸ä¼šå¼•èµ·ä¸å¿…è¦çš„å¼€é”€ï¼Œä¹Ÿä¼šé™åˆ¶ç¨‹åºçš„å¯æ‰©å±•æ€§å’Œå¯è¯»æ€§ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œæœ‰æ—¶å€™éœ€è¦å¯¹å¤šè¿›ç¨‹å…±äº«çš„å†…å­˜åˆ†é…ä¼˜å…ˆçº§ï¼Œä½¿ç”¨é”å¯èƒ½å’Œè¿™ç§ä¼˜å…ˆçº§å†²çªã€‚æœ€åï¼Œä»å®è·µçš„ç»éªŒæ¥çœ‹ï¼Œä½¿ç”¨é”çš„åº”ç”¨å°†å¯¹debugå¸¦æ¥ä¸å°çš„éº»çƒ¦ã€‚æ‰€ä»¥ï¼Œæœ€å¥½ä½¿ç”¨å…¶ä»–å¯é€‰çš„æ–¹æ³•ç¡®ä¿åŒæ­¥è¯»å–å…±äº«å†…å­˜ï¼Œé¿å…ç«äº‰æ¡ä»¶ã€‚</p>
<h2 id="7-é€’å½’é”rlock">7. é€’å½’é”RLOCK</h2>
<p>RLockå…¶å®å«åšâ€œReentrant Lockâ€ï¼Œå°±æ˜¯å¯ä»¥é‡å¤è¿›å…¥çš„é”ï¼Œä¹Ÿå«åšâ€œé€’å½’é”â€ã€‚è¿™ç§é”å¯¹æ¯”Lockæœ‰æ˜¯ä¸‰ä¸ªç‰¹ç‚¹ï¼š1. è°æ‹¿åˆ°è°é‡Šæ”¾ã€‚å¦‚æœçº¿ç¨‹Aæ‹¿åˆ°é”ï¼Œçº¿ç¨‹Bæ— æ³•é‡Šæ”¾è¿™ä¸ªé”ï¼Œåªæœ‰Aå¯ä»¥é‡Šæ”¾ï¼›2. åŒä¸€çº¿ç¨‹å¯ä»¥å¤šæ¬¡æ‹¿åˆ°è¯¥é”ï¼Œå³å¯ä»¥acquireå¤šæ¬¡ï¼›3. acquireå¤šå°‘æ¬¡å°±å¿…é¡»releaseå¤šå°‘æ¬¡ï¼Œåªæœ‰æœ€åä¸€æ¬¡releaseæ‰èƒ½æ”¹å˜RLockçš„çŠ¶æ€ä¸ºunlocked</p>
<p>å¦‚æœæ˜¯ä¸€æŠŠäº’æ–¥é”ï¼ˆthreading.Lock()ï¼‰ï¼Œé‚£ä¹ˆä¸‹é¢çš„ä»£ç ä¼šå‘ç”Ÿå µå¡ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">threadinglock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;è·å–ç¬¬äºŒæŠŠé”&#39;</span><span class="p">)</span>        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;test.......{i}&#39;</span><span class="p">)</span>        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>    <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>åŒæ ·çš„ä»£ç ï¼Œå¦‚æœæ¢æˆï¼ˆthreading.RLock()ï¼‰ï¼Œåˆ™ä¸ä¼šå‘ç”Ÿå µå¡ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">threadinglock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;è·å–ç¬¬äºŒæŠŠé”&#39;</span><span class="p">)</span>        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;test.......{i}&#39;</span><span class="p">)</span>        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>    <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>RLockå…¶å®åº•å±‚ç»´æŠ¤äº†ä¸€ä¸ªäº’æ–¥é”å’Œä¸€ä¸ªè®¡æ•°å™¨</strong></p>
<h2 id="8-ä¿¡å·é‡">8. ä¿¡å·é‡</h2>
<p><strong>ä¿¡å·é‡ä¹Ÿæ˜¯ä¸€æŠŠé”ï¼Œç”¨æ¥æ§åˆ¶çº¿ç¨‹å¹¶å‘æ•°çš„</strong>ã€‚BoundedSemaphoreæˆ–Semaphoreç®¡ç†ä¸€ä¸ªå†…ç½®çš„è®¡æ•° å™¨ï¼Œæ¯å½“è°ƒç”¨acquire()æ—¶-1ï¼Œè°ƒç”¨release()æ—¶+1ã€‚</p>
<p>è®¡æ•°å™¨ä¸èƒ½å°äº0ï¼Œå½“è®¡æ•°å™¨ä¸º 0æ—¶ï¼Œacquire()å°†é˜»å¡çº¿ç¨‹è‡³åŒæ­¥é”å®šçŠ¶æ€ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹è°ƒç”¨release()ã€‚(ç±»ä¼¼äºåœè½¦ä½çš„æ¦‚å¿µ)</p>
<p>ç±»åï¼šBoundedSemaphoreã€‚è¿™ç§é”å…è®¸ä¸€å®šæ•°é‡çš„çº¿ç¨‹åŒæ—¶æ›´æ”¹æ•°æ®ï¼Œå®ƒä¸æ˜¯äº’æ–¥é”ã€‚æ¯”å¦‚åœ°é“å®‰æ£€ï¼Œæ’é˜Ÿäººå¾ˆå¤šï¼Œå·¥ä½œäººå‘˜åªå…è®¸ä¸€å®šæ•°é‡çš„äººè¿›å…¥å®‰æ£€åŒºï¼Œå…¶å®ƒçš„äººç»§ç»­æ’é˜Ÿã€‚</p>
<p>åŒæ ·çš„ï¼Œåœ¨threadingæ¨¡å—ä¸­ï¼Œä¿¡å·é‡çš„æ“ä½œæœ‰ä¸¤ä¸ªå‡½æ•°ï¼Œå³ <code>acquire()</code> å’Œ <code>release()</code> ï¼Œè§£é‡Šå¦‚ä¸‹ï¼š</p>
<ul>
<li>æ¯å½“çº¿ç¨‹æƒ³è¦è¯»å–å…³è”äº†ä¿¡å·é‡çš„å…±äº«èµ„æºæ—¶ï¼Œå¿…é¡»è°ƒç”¨ <code>acquire()</code> ï¼Œæ­¤æ“ä½œå‡å°‘ä¿¡å·é‡çš„å†…éƒ¨å˜é‡, å¦‚æœæ­¤å˜é‡çš„å€¼éè´Ÿï¼Œé‚£ä¹ˆåˆ†é…è¯¥èµ„æºçš„æƒé™ã€‚å¦‚æœæ˜¯è´Ÿå€¼ï¼Œé‚£ä¹ˆçº¿ç¨‹è¢«æŒ‚èµ·ï¼Œç›´åˆ°æœ‰å…¶ä»–çš„çº¿ç¨‹é‡Šæ”¾èµ„æºã€‚</li>
<li>å½“çº¿ç¨‹ä¸å†éœ€è¦è¯¥å…±äº«èµ„æºï¼Œå¿…é¡»é€šè¿‡ <code>release()</code> é‡Šæ”¾ã€‚è¿™æ ·ï¼Œä¿¡å·é‡çš„å†…éƒ¨å˜é‡å¢åŠ ï¼Œåœ¨ä¿¡å·é‡ç­‰å¾…é˜Ÿåˆ—ä¸­æ’åœ¨æœ€å‰é¢çš„çº¿ç¨‹ä¼šæ‹¿åˆ°å…±äº«èµ„æºçš„æƒé™ã€‚</li>
</ul>
<p>




<img loading="lazy" decoding="async"
         src="https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/semaphores.png"
         alt="../_images/semaphores.png"
         title="semaphores.png"
    /></p>
<h3 id="81-ä»£ç ">8.1 ä»£ç </h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">timeimport</span> <span class="nn">threadingdef</span> <span class="nn">run</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">se</span><span class="p">):</span>    <span class="n">se</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;run the thread: </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>    <span class="n">se</span><span class="o">.</span><span class="n">release</span><span class="p">()</span><span class="c1"># è®¾ç½®å…è®¸5ä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œsemaphore = threading.BoundedSemaphore(5)for i in range(20):    t = threading.Thread(target=run, args=(i, semaphore))    t.start()</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<p>â€‹	




<img loading="lazy" decoding="async"
         src="https://typora-1300715298.cos.ap-shanghai.myqcloud.com/uPic/image-20210624101949016.png"
         alt="BoundedSemaphore"
         title="image-20210624101949016.png"
    /></p>
<h3 id="82-æ¶ˆè´¹è€…æ¨¡å‹çš„ä¿¡å·é‡ä½¿ç”¨">8.2 æ¶ˆè´¹è€…æ¨¡å‹çš„ä¿¡å·é‡ä½¿ç”¨</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># -*- coding: utf-8 -*-&#34;&#34;&#34;Using a Semaphore to synchronize threads&#34;&#34;&#34;import threadingimport timeimport random# The optional argument gives the initial value for the internal# counter;# it defaults to 1.# If the value given is less than 0, ValueError is raised.semaphore = threading.Semaphore(0)def consumer():        print(&#34;consumer is waiting.&#34;)        # Acquire a semaphore        semaphore.acquire()        # The consumer have access to the shared resource        print(&#34;Consumer notify : consumed item number %s &#34; % item)def producer():        global item        time.sleep(10)        # create a random item        item = random.randint(0, 1000)        print(&#34;producer notify : produced item number %s&#34; % item)         # Release a semaphore, incrementing the internal counter by one.        # When it is zero on entry and another thread is waiting for it        # to become larger than zero again, wake up that thread.        semaphore.release()if __name__ == &#39;__main__&#39;:        for i in range (0,5) :                t1 = threading.Thread(target=producer)                t2 = threading.Thread(target=consumer)                t1.start()                t2.start()                t1.join()                t2.join()        print(&#34;program terminated&#34;)</span>
</code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬ä½¿ç”¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹å±•ç¤ºé€šè¿‡ä¿¡å·é‡çš„åŒæ­¥ã€‚å½“ç”Ÿäº§è€…ç”Ÿäº§å‡ºitemï¼Œä¾¿é‡Šæ”¾ä¿¡å·é‡ã€‚ç„¶åæ¶ˆè´¹è€…æ‹¿åˆ°èµ„æºè¿›è¡Œæ¶ˆè´¹ã€‚</p>
<p>è¿è¡Œç»“æœï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"> <span class="err">â†µ</span>  <span class="n">python</span> <span class="o">-</span><span class="n">u</span> <span class="n">thread_semaphore</span><span class="o">.</span><span class="n">pyconsumer</span> <span class="ow">is</span> <span class="n">waiting</span><span class="o">.</span><span class="n">producer</span> <span class="n">notify</span> <span class="p">:</span> <span class="n">produced</span> <span class="n">item</span> <span class="n">number</span> <span class="mi">328</span><span class="n">Consumer</span> <span class="n">notify</span> <span class="p">:</span> <span class="n">consumed</span> <span class="n">item</span> <span class="n">number</span> <span class="mi">328</span> <span class="n">consumer</span> <span class="ow">is</span> <span class="n">waiting</span><span class="o">.</span><span class="n">producer</span> <span class="n">notify</span> <span class="p">:</span> <span class="n">produced</span> <span class="n">item</span> <span class="n">number</span> <span class="mi">230</span><span class="n">Consumer</span> <span class="n">notify</span> <span class="p">:</span> <span class="n">consumed</span> <span class="n">item</span> <span class="n">number</span> <span class="mi">230</span> <span class="n">consumer</span> <span class="ow">is</span> <span class="n">waiting</span><span class="o">.</span><span class="n">producer</span> <span class="n">notify</span> <span class="p">:</span> <span class="n">produced</span> <span class="n">item</span> <span class="n">number</span> <span class="mi">174</span><span class="n">Consumer</span> <span class="n">notify</span> <span class="p">:</span> <span class="n">consumed</span> <span class="n">item</span> <span class="n">number</span> <span class="mi">174</span> <span class="n">consumer</span> <span class="ow">is</span> <span class="n">waiting</span><span class="o">.</span><span class="n">producer</span> <span class="n">notify</span> <span class="p">:</span> <span class="n">produced</span> <span class="n">item</span> <span class="n">number</span> <span class="mi">573</span><span class="n">Consumer</span> <span class="n">notify</span> <span class="p">:</span> <span class="n">consumed</span> <span class="n">item</span> <span class="n">number</span> <span class="mi">573</span> <span class="n">consumer</span> <span class="ow">is</span> <span class="n">waiting</span><span class="o">.</span><span class="n">producer</span> <span class="n">notify</span> <span class="p">:</span> <span class="n">produced</span> <span class="n">item</span> <span class="n">number</span> <span class="mi">286</span><span class="n">Consumer</span> <span class="n">notify</span> <span class="p">:</span> <span class="n">consumed</span> <span class="n">item</span> <span class="n">number</span> <span class="mi">286</span> <span class="n">program</span> <span class="n">terminated</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="9-æ¡ä»¶çº¿ç¨‹è®¾ç½®">9. æ¡ä»¶çº¿ç¨‹è®¾ç½®</h2>
<p>æ¡ä»¶æŒ‡çš„æ˜¯åº”ç”¨ç¨‹åºçŠ¶æ€çš„æ”¹å˜ã€‚è¿™æ˜¯å¦ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œå…¶ä¸­æŸäº›çº¿ç¨‹åœ¨ç­‰å¾…æŸä¸€æ¡ä»¶å‘ç”Ÿï¼Œå…¶ä»–çš„çº¿ç¨‹ä¼šåœ¨è¯¥æ¡ä»¶å‘ç”Ÿçš„æ—¶å€™è¿›è¡Œé€šçŸ¥ã€‚ä¸€æ—¦æ¡ä»¶å‘ç”Ÿï¼Œçº¿ç¨‹ä¼šæ‹¿åˆ°å…±äº«èµ„æºçš„å”¯ä¸€æƒé™ã€‚</p>
<h3 id="91-ä»£ç ">9.1 ä»£ç </h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">Conditionimport</span> <span class="n">timeitems</span> <span class="o">=</span> <span class="p">[]</span><span class="n">condition</span> <span class="o">=</span> <span class="n">Condition</span><span class="p">()</span><span class="k">class</span> <span class="nc">consumer</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>    <span class="k">def</span> <span class="nf">consume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">global</span> <span class="n">condition</span>        <span class="k">global</span> <span class="n">items</span>        <span class="n">condition</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>            <span class="n">condition</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>            <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Consumer notify : no item to consume&#34;</span><span class="p">)</span>        <span class="n">items</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Consumer notify : consumed 1 item&#34;</span><span class="p">)</span>        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Consumer notify : items to consume are &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)))</span>        <span class="n">condition</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>        <span class="n">condition</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>            <span class="bp">self</span><span class="o">.</span><span class="n">consume</span><span class="p">()</span><span class="k">class</span> <span class="nc">producer</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>    <span class="k">def</span> <span class="nf">produce</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">global</span> <span class="n">condition</span>        <span class="k">global</span> <span class="n">items</span>        <span class="n">condition</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>            <span class="n">condition</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>            <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Producer notify : items producted are &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)))</span>            <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Producer notify : stop the production!!&#34;</span><span class="p">)</span>        <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Producer notify : total items producted &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)))</span>        <span class="n">condition</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>        <span class="n">condition</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>            <span class="bp">self</span><span class="o">.</span><span class="n">produce</span><span class="p">()</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>    <span class="n">producer</span> <span class="o">=</span> <span class="n">producer</span><span class="p">()</span>    <span class="n">consumer</span> <span class="o">=</span> <span class="n">consumer</span><span class="p">()</span>    <span class="n">producer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>    <span class="n">consumer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>    <span class="n">producer</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>    <span class="n">consumer</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<p>




<img loading="lazy" decoding="async"
         src="https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/Page-75-Image-12.png"
         alt="../_images/Page-75-Image-12.png"
         title="Page-75-Image-12.png"
    /></p>
<p>(è¯‘è€…åœ¨è¿™é‡Œæ·»åŠ ä¸€æ®µã€‚ä¹ä¸€çœ‹è¿™æ®µä»£ç å¥½åƒä¼šæ­»é”ï¼Œå› ä¸º <code>condition.acquire()</code> ä¹‹åå°±åœ¨ <code>.wait()</code> äº†ï¼Œå¥½åƒä¼šä¸€ç›´æŒæœ‰é”ã€‚å…¶å® <code>.wait()</code> ä¼šå°†é”é‡Šæ”¾ï¼Œç„¶åç­‰å¾…å…¶ä»–çº¿ç¨‹ <code>.notify()</code> ä¹‹åä¼šé‡æ–°å°è¯•è·å¾—é”ã€‚ä½†æ˜¯è¦æ³¨æ„ <code>.notify()</code> å¹¶ä¸ä¼šè‡ªåŠ¨é‡Šæ”¾é”ï¼Œæ‰€ä»¥ä»£ç ä¸­æœ‰ä¸¤è¡Œï¼Œå…ˆ <code>.notify()</code> ç„¶åå† <code>.release()</code> ã€‚</p>
<p>è¯‘è€…ç”»äº†ä¸€å¼ å›¾ï¼Œæ–¹ä¾¿å¤§å®¶ç†è§£ã€‚è¿™é‡Œçš„è¿‡ç¨‹åº”è¯¥æ˜¯è¿™æ ·å­çš„ï¼ˆæ³¨æ„ <code>wait()</code> é‡Œé¢å®é™…æœ‰ä¸€ä¸ªé‡Šæ”¾é”é‡æ–°è·å¾—é”çš„è¿‡ç¨‹ï¼‰ï¼š</p>
<p>




<img loading="lazy" decoding="async"
         src="https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/python-condition.png"
         alt="../_images/python-condition.png"
         title="python-condition.png"
    /></p>
<p>è¯‘è€…çš„ç§è´§å®Œæ¯•ï¼Œå»ºè®®çœ‹ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£ï¼š <a href="https://docs.python.org/3/library/threading.html">https://docs.python.org/3/library/threading.html</a> )</p>
<p>æ¶ˆè´¹è€…é€šè¿‡æ‹¿åˆ°é”æ¥ä¿®æ”¹å…±äº«çš„èµ„æº <code>items[]</code> ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">condition.acquire()
</code></pre></td></tr></table>
</div>
</div><p>å¦‚æœlistçš„é•¿åº¦ä¸º0ï¼Œé‚£ä¹ˆæ¶ˆè´¹è€…å°±è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">if len(items) == 0:    condition.wait()
</code></pre></td></tr></table>
</div>
</div><p>å¦åˆ™å°±é€šè¿‡ <code>pop</code> æ“ä½œæ¶ˆè´¹ä¸€ä¸ªitemï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">items.pop()
</code></pre></td></tr></table>
</div>
</div><p>ç„¶åï¼Œæ¶ˆè´¹è€…çš„çŠ¶æ€è¢«é€šçŸ¥ç»™ç”Ÿäº§è€…ï¼ŒåŒæ—¶å…±äº«èµ„æºé‡Šæ”¾ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">condition.notify()condition.release()
</code></pre></td></tr></table>
</div>
</div><p>ç”Ÿäº§è€…æ‹¿åˆ°å…±äº«èµ„æºï¼Œç„¶åç¡®è®¤ç¼“å†²é˜Ÿåˆ—æ˜¯å¦å·²æ»¡ï¼ˆåœ¨æˆ‘ä»¬çš„è¿™ä¸ªä¾‹å­ä¸­ï¼Œæœ€å¤§å¯ä»¥å­˜æ”¾10ä¸ªitemï¼‰ï¼Œå¦‚æœå·²ç»æ»¡äº†ï¼Œé‚£ä¹ˆç”Ÿäº§è€…è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°è¢«å”¤é†’ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">condition.acquire()if len(items) == 10:    condition.wait()
</code></pre></td></tr></table>
</div>
</div><p>å¦‚æœé˜Ÿåˆ—æ²¡æœ‰æ»¡ï¼Œå°±ç”Ÿäº§1ä¸ªitemï¼Œé€šçŸ¥çŠ¶æ€å¹¶é‡Šæ”¾èµ„æºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">condition.notify()condition.release()
</code></pre></td></tr></table>
</div>
</div><h2 id="10-äº‹ä»¶è¿›è¡Œçº¿ç¨‹åŒæ­¥">10. äº‹ä»¶è¿›è¡Œçº¿ç¨‹åŒæ­¥</h2>
<p>äº‹ä»¶æ˜¯çº¿ç¨‹ä¹‹é—´ç”¨äºé€šè®¯çš„å¯¹è±¡ã€‚æœ‰çš„çº¿ç¨‹ç­‰å¾…ä¿¡å·ï¼Œæœ‰çš„çº¿ç¨‹å‘å‡ºä¿¡å·ã€‚åŸºæœ¬ä¸Šäº‹ä»¶å¯¹è±¡éƒ½ä¼šç»´æŠ¤ä¸€ä¸ªå†…éƒ¨å˜é‡ï¼Œå¯ä»¥é€šè¿‡ <code>set()</code> æ–¹æ³•è®¾ç½®ä¸º <code>true</code> ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ <code>clear()</code> æ–¹æ³•è®¾ç½®ä¸º <code>false</code> ã€‚ <code>wait()</code> æ–¹æ³•å°†ä¼šé˜»å¡çº¿ç¨‹ï¼Œç›´åˆ°å†…éƒ¨å˜é‡ä¸º <code>true</code> ã€‚</p>
<h3 id="101-ä»£ç ">10.1 ä»£ç </h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">timefrom</span> <span class="nn">threading</span> <span class="nn">import</span> <span class="nn">Thread</span><span class="o">,</span> <span class="nn">Eventimport</span> <span class="nn">randomitems</span> <span class="o">=</span> <span class="p">[]</span><span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span><span class="k">class</span> <span class="nc">consumer</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>        <span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">items</span>        <span class="bp">self</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">event</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>            <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Consumer notify : </span><span class="si">%d</span><span class="s1"> popped from list by </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span><span class="k">class</span> <span class="nc">producer</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>        <span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">items</span>        <span class="bp">self</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">event</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">global</span> <span class="n">item</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>            <span class="n">item</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>            <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Producer notify : item NÂ° </span><span class="si">%d</span><span class="s1"> appended to list by </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Producer notify : event set by </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>            <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Produce notify : event cleared by </span><span class="si">%s</span><span class="s1"> &#39;</span><span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>            <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>    <span class="n">t1</span> <span class="o">=</span> <span class="n">producer</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>    <span class="n">t2</span> <span class="o">=</span> <span class="n">consumer</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>    <span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>    <span class="n">t2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>    <span class="n">t1</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>    <span class="n">t2</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>çº¿ç¨‹t1åœ¨listæœ€åæ·»åŠ å€¼ï¼Œç„¶åè®¾ç½®eventæ¥é€šçŸ¥æ¶ˆè´¹è€…ã€‚æ¶ˆè´¹è€…é€šè¿‡ <code>wait()</code> é˜»å¡ï¼Œç›´åˆ°æ”¶åˆ°ä¿¡å·çš„æ—¶å€™ä»listä¸­å–å‡ºå…ƒç´ æ¶ˆè´¹ã€‚</p>
<p>è¿è¡Œç»“æœï¼š</p>
<p>




<img loading="lazy" decoding="async"
         src="https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/Page-78-Image-13.png"
         alt="../_images/Page-78-Image-13.png"
         title="Page-78-Image-13.png"
    /></p>
<p>è§£é‡Šï¼š</p>
<p><code>producer</code> ç±»åˆå§‹åŒ–æ—¶å®šä¹‰äº†itemçš„listå’Œ <code>Event</code> ï¼Œä¸æ¡ä»¶å¯¹è±¡æ—¶å€™çš„ä¾‹å­ä¸åŒï¼Œè¿™é‡Œçš„listå¹¶ä¸æ˜¯å…¨å±€çš„ï¼Œè€Œæ˜¯é€šè¿‡å‚æ•°ä¼ å…¥çš„ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">class consumer(Thread):    def __init__(self, items, event):        Thread.__init__(self)        self.items = items        self.event = event
</code></pre></td></tr></table>
</div>
</div><p>åœ¨runæ–¹æ³•ä¸­ï¼Œæ¯å½“itemåˆ›å»ºï¼Œ <code>producer</code> ç±»å°†æ–°itemæ·»åŠ åˆ°listæœ«å°¾ç„¶åå‘å‡ºäº‹ä»¶é€šçŸ¥ã€‚ä½¿ç”¨äº‹ä»¶æœ‰ä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">self.event.set()
</code></pre></td></tr></table>
</div>
</div><p>ç¬¬äºŒæ­¥ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">self.event.clear()
</code></pre></td></tr></table>
</div>
</div><p><code>consumer</code> ç±»åˆå§‹åŒ–æ—¶ä¹Ÿå®šä¹‰äº†itemçš„listå’Œ <code>Event()</code> ã€‚å½“itemè¿›æ¥çš„æ—¶å€™ï¼Œå®ƒå°†å…¶å–å‡ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">def run(self):    while True:        time.sleep(2)        self.event.wait()        item = self.items.pop()        print(&#39;Consumer notify : %d popped from list by %s&#39; % (item, self.name))
</code></pre></td></tr></table>
</div>
</div><p>ä¸‹å›¾å¯ä»¥å¸®æˆ‘ä»¬è®¤è¯† <code>producer</code> å’Œ <code>consumer</code> ï¼š</p>
<p>




<img loading="lazy" decoding="async"
         src="https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/event.png"
         alt="../_images/event.png"
         title="event.png"
    /></p>
<h2 id="11-çº¿ç¨‹ä¸­çš„withè¯­å¥">11. çº¿ç¨‹ä¸­çš„withè¯­å¥</h2>
<p>Pythonä»2.5ç‰ˆæœ¬å¼€å§‹å¼•å…¥äº† <code>with</code> è¯­æ³•ã€‚æ­¤è¯­æ³•éå¸¸å®ç”¨ï¼Œåœ¨æœ‰ä¸¤ä¸ªç›¸å…³çš„æ“ä½œéœ€è¦åœ¨ä¸€éƒ¨åˆ†ä»£ç å—å‰ååˆ†åˆ«æ‰§è¡Œçš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ <code>with</code> è¯­æ³•è‡ªåŠ¨å®Œæˆã€‚åŒäº‹ï¼Œä½¿ç”¨ <code>with</code> è¯­æ³•å¯ä»¥åœ¨ç‰¹å®šçš„åœ°æ–¹åˆ†é…å’Œé‡Šæ”¾èµ„æºï¼Œå› æ­¤ï¼Œ <code>with</code> è¯­æ³•ä¹Ÿå«åšâ€œä¸Šä¸‹æ–‡ç®¡ç†å™¨â€ã€‚åœ¨threadingæ¨¡å—ä¸­ï¼Œæ‰€æœ‰å¸¦æœ‰ <code>acquire()</code> æ–¹æ³•å’Œ <code>release()</code> æ–¹æ³•çš„å¯¹è±¡éƒ½å¯ä»¥ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸‹é¢çš„å¯¹è±¡å¯ä»¥ä½¿ç”¨ <code>with</code> è¯­æ³•ï¼š</p>
<ul>
<li>Lock</li>
<li>RLock</li>
<li>Condition</li>
<li>Semaphore</li>
</ul>
<h3 id="111-ä»£ç ">11.1 ä»£ç </h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">threadingimport</span> <span class="nn">logginglogging.basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;(</span><span class="si">%(threadName)-10s</span><span class="s1">) </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,)</span><span class="k">def</span> <span class="nf">threading_with</span><span class="p">(</span><span class="n">statement</span><span class="p">):</span>    <span class="k">with</span> <span class="n">statement</span><span class="p">:</span>        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> acquired via with&#39;</span> <span class="o">%</span> <span class="n">statement</span><span class="p">)</span><span class="k">def</span> <span class="nf">threading_not_with</span><span class="p">(</span><span class="n">statement</span><span class="p">):</span>    <span class="n">statement</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>    <span class="k">try</span><span class="p">:</span>        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> acquired directly&#39;</span> <span class="o">%</span> <span class="n">statement</span> <span class="p">)</span>    <span class="k">finally</span><span class="p">:</span>        <span class="n">statement</span><span class="o">.</span><span class="n">release</span><span class="p">()</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>    <span class="c1"># let&#39;s create a test battery    lock = threading.Lock()    rlock = threading.RLock()    condition = threading.Condition()    mutex = threading.Semaphore(1)    threading_synchronization_list = [lock, rlock, condition, mutex]    # in the for cycle we call the threading_with e threading_no_with function    for statement in threading_synchronization_list :       t1 = threading.Thread(target=threading_with, args=(statement,))       t2 = threading.Thread(target=threading_not_with, args=(statement,))       t1.start()       t2.start()       t1.join()       t2.join()</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœ:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="err">â†µ</span> <span class="n">python</span> <span class="o">-</span><span class="n">u</span> <span class="n">thread_with</span><span class="o">.</span><span class="n">py</span><span class="p">(</span><span class="n">Thread</span><span class="o">-</span><span class="mi">1</span>  <span class="p">)</span> <span class="o">&lt;</span><span class="n">locked</span> <span class="n">_thread</span><span class="o">.</span><span class="n">lock</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x1019a1450</span><span class="o">&gt;</span> <span class="n">acquired</span> <span class="n">via</span> <span class="k">with</span><span class="p">(</span><span class="n">Thread</span><span class="o">-</span><span class="mi">2</span>  <span class="p">)</span> <span class="o">&lt;</span><span class="n">locked</span> <span class="n">_thread</span><span class="o">.</span><span class="n">lock</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x1019a1450</span><span class="o">&gt;</span> <span class="n">acquired</span> <span class="n">directly</span><span class="p">(</span><span class="n">Thread</span><span class="o">-</span><span class="mi">3</span>  <span class="p">)</span> <span class="o">&lt;</span><span class="n">locked</span> <span class="n">_thread</span><span class="o">.</span><span class="n">RLock</span> <span class="nb">object</span> <span class="n">owner</span><span class="o">=</span><span class="mi">123145583611904</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span> <span class="n">at</span> <span class="mh">0x1019a1420</span><span class="o">&gt;</span> <span class="n">acquired</span> <span class="n">via</span> <span class="k">with</span><span class="p">(</span><span class="n">Thread</span><span class="o">-</span><span class="mi">4</span>  <span class="p">)</span> <span class="o">&lt;</span><span class="n">locked</span> <span class="n">_thread</span><span class="o">.</span><span class="n">RLock</span> <span class="nb">object</span> <span class="n">owner</span><span class="o">=</span><span class="mi">123145583611904</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span> <span class="n">at</span> <span class="mh">0x1019a1420</span><span class="o">&gt;</span> <span class="n">acquired</span> <span class="n">directly</span><span class="p">(</span><span class="n">Thread</span><span class="o">-</span><span class="mi">5</span>  <span class="p">)</span> <span class="o">&lt;</span><span class="n">Condition</span><span class="p">(</span><span class="o">&lt;</span><span class="n">locked</span> <span class="n">_thread</span><span class="o">.</span><span class="n">RLock</span> <span class="nb">object</span> <span class="n">owner</span><span class="o">=</span><span class="mi">123145583611904</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span> <span class="n">at</span> <span class="mh">0x1019a19c0</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">acquired</span> <span class="n">via</span> <span class="k">with</span><span class="p">(</span><span class="n">Thread</span><span class="o">-</span><span class="mi">6</span>  <span class="p">)</span> <span class="o">&lt;</span><span class="n">Condition</span><span class="p">(</span><span class="o">&lt;</span><span class="n">locked</span> <span class="n">_thread</span><span class="o">.</span><span class="n">RLock</span> <span class="nb">object</span> <span class="n">owner</span><span class="o">=</span><span class="mi">123145600401408</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span> <span class="n">at</span> <span class="mh">0x1019a19c0</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">acquired</span> <span class="n">directly</span><span class="p">(</span><span class="n">Thread</span><span class="o">-</span><span class="mi">7</span>  <span class="p">)</span> <span class="o">&lt;</span><span class="n">threading</span><span class="o">.</span><span class="n">Semaphore</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x101818910</span><span class="o">&gt;</span> <span class="n">acquired</span> <span class="n">via</span> <span class="k">with</span><span class="p">(</span><span class="n">Thread</span><span class="o">-</span><span class="mi">8</span>  <span class="p">)</span> <span class="o">&lt;</span><span class="n">threading</span><span class="o">.</span><span class="n">Semaphore</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x101818910</span><span class="o">&gt;</span> <span class="n">acquired</span> <span class="n">directly</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="102-è§£é‡Š">10.2 è§£é‡Š</h3>
<p>åœ¨ä¸»ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªlistï¼Œ <code>threading_synchronization_list</code> ï¼ŒåŒ…å«è¦æµ‹è¯•çš„çº¿ç¨‹åŒæ­¥ä½¿ç”¨çš„å¯¹è±¡ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">lock = threading.Lock()rlock = threading.RLock()condition = threading.Condition()mutex = threading.Semaphore(1)threading_synchronization_list = [lock, rlock, condition, mutex]
</code></pre></td></tr></table>
</div>
</div><p>å®šä¹‰ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ <code>for</code> å¾ªç¯ä¸­æµ‹è¯•æ¯ä¸€ä¸ªå¯¹è±¡ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">for statement in threading_synchronization_list :   t1 = threading.Thread(target=threading_with, args=(statement,))   t2 = threading.Thread(target=threading_not_with, args=(statement,))
</code></pre></td></tr></table>
</div>
</div><p>æœ€åï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªç›®æ ‡å‡½æ•°ï¼Œå…¶ä¸­ <code>threading_with</code> æµ‹è¯•äº† <code>with</code> è¯­æ³•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">def threading_with(statement):    with statement:        logging.debug(&#39;%s acquired via with&#39; % statement)
</code></pre></td></tr></table>
</div>
</div><h2 id="12-ä½¿ç”¨é˜Ÿåˆ—è¿›è¡Œçº¿ç¨‹é€šä¿¡">12. ä½¿ç”¨é˜Ÿåˆ—è¿›è¡Œçº¿ç¨‹é€šä¿¡</h2>
<p>å½“çº¿ç¨‹ä¹‹é—´å¦‚æœè¦å…±äº«èµ„æºæˆ–æ•°æ®çš„æ—¶å€™ï¼Œå¯èƒ½å˜çš„éå¸¸å¤æ‚ã€‚å¦‚ä½ æ‰€è§ï¼ŒPythonçš„threadingæ¨¡å—æä¾›äº†å¾ˆå¤šåŒæ­¥åŸè¯­ï¼ŒåŒ…æ‹¬ä¿¡å·é‡ï¼Œæ¡ä»¶å˜é‡ï¼Œäº‹ä»¶å’Œé”ã€‚å¦‚æœå¯ä»¥ä½¿ç”¨è¿™äº›åŸè¯­çš„è¯ï¼Œåº”è¯¥ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨è¿™äº›ï¼Œè€Œä¸æ˜¯ä½¿ç”¨queueï¼ˆé˜Ÿåˆ—ï¼‰æ¨¡å—ã€‚é˜Ÿåˆ—æ“ä½œèµ·æ¥æ›´å®¹æ˜“ï¼Œä¹Ÿä½¿å¤šçº¿ç¨‹ç¼–ç¨‹æ›´å®‰å…¨ï¼Œå› ä¸ºé˜Ÿåˆ—å¯ä»¥å°†èµ„æºçš„ä½¿ç”¨é€šè¿‡å•çº¿ç¨‹è¿›è¡Œå®Œå…¨æ§åˆ¶ï¼Œå¹¶ä¸”å…è®¸ä½¿ç”¨æ›´åŠ æ•´æ´å’Œå¯è¯»æ€§æ›´é«˜çš„è®¾è®¡æ¨¡å¼ã€‚</p>
<p>Queueå¸¸ç”¨çš„æ–¹æ³•æœ‰ä»¥ä¸‹å››ä¸ªï¼š</p>
<ul>
<li><code>put()</code>: å¾€queueä¸­æ”¾ä¸€ä¸ªitem</li>
<li><code>get()</code>: ä»queueåˆ é™¤ä¸€ä¸ªitemï¼Œå¹¶è¿”å›åˆ é™¤çš„è¿™ä¸ªitem</li>
<li><code>task_done()</code>: æ¯æ¬¡itemè¢«å¤„ç†çš„æ—¶å€™éœ€è¦è°ƒç”¨è¿™ä¸ªæ–¹æ³•</li>
<li><code>join()</code>: æ‰€æœ‰iteméƒ½è¢«å¤„ç†ä¹‹å‰ä¸€ç›´é˜»å¡</li>
</ul>
<h3 id="122-ä»£ç ">12.2 ä»£ç </h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">Eventfrom</span> <span class="n">queue</span> <span class="kn">import</span> <span class="nn">Queueimport</span> <span class="nn">timeimport</span> <span class="nn">randomclass</span> <span class="nn">producer</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>        <span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>            <span class="n">item</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Producer notify: item NÂ° </span><span class="si">%d</span><span class="s1"> appended to queue by </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="k">class</span> <span class="nc">consumer</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>        <span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Consumer notify : </span><span class="si">%d</span><span class="s1"> popped from queue by </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>    <span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>    <span class="n">t1</span> <span class="o">=</span> <span class="n">producer</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>    <span class="n">t2</span> <span class="o">=</span> <span class="n">consumer</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>    <span class="n">t3</span> <span class="o">=</span> <span class="n">consumer</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>    <span class="n">t4</span> <span class="o">=</span> <span class="n">consumer</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>    <span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>    <span class="n">t2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>    <span class="n">t3</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>    <span class="n">t4</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>    <span class="n">t1</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>    <span class="n">t2</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>    <span class="n">t3</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>    <span class="n">t4</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<p>




<img loading="lazy" decoding="async"
         src="https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/Page-85-Image-15.png"
         alt="../_images/Page-85-Image-15.png"
         title="Page-85-Image-15.png"
    /></p>
<h3 id="122-è§£é‡Š">12.2 è§£é‡Š</h3>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç”Ÿäº§è€…ç±»ã€‚ç”±äºæˆ‘ä»¬ä½¿ç”¨é˜Ÿåˆ—å­˜æ”¾æ•°å­—ï¼Œæ‰€ä»¥ä¸éœ€è¦ç”¨æ¥å­˜æ”¾æ•°å­—çš„listäº†ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">class producer(Thread):    def __init__(self, queue):        Thread.__init__(self)        self.queue = queue
</code></pre></td></tr></table>
</div>
</div><p><code>producer</code> ç±»ç”Ÿäº§æ•´æ•°ï¼Œç„¶åé€šè¿‡ä¸€ä¸ª <code>for</code> å¾ªç¯å°†æ•´æ•°æ”¾åˆ°é˜Ÿåˆ—ä¸­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">def run(self) :    for i in range(10):        item = random.randint(0, 256)        self.queue.put(item)        print(&#39;Producer notify: item NÂ° %d appended to queue by %s&#39; % (item, self.name))        time.sleep(1)
</code></pre></td></tr></table>
</div>
</div><p>ç”Ÿäº§è€…ä½¿ç”¨ <code>Queue.put(item [,block[, timeout]])</code> æ¥å¾€queueä¸­æ’å…¥æ•°æ®ã€‚Queueæ˜¯åŒæ­¥çš„ï¼Œåœ¨æ’å…¥æ•°æ®ä¹‹å‰å†…éƒ¨æœ‰ä¸€ä¸ªå†…ç½®çš„é”æœºåˆ¶ã€‚</p>
<p>å¯èƒ½å‘ç”Ÿä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li>å¦‚æœ <code>block</code> ä¸º <code>True</code> ï¼Œ <code>timeout</code> ä¸º <code>None</code> ï¼ˆè¿™ä¹Ÿæ˜¯é»˜è®¤çš„é€‰é¡¹ï¼Œæœ¬ä¾‹ä¸­ä½¿ç”¨é»˜è®¤é€‰é¡¹ï¼‰ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šé˜»å¡æ‰ï¼Œç›´åˆ°å‡ºç°å¯ç”¨çš„ä½ç½®ã€‚å¦‚æœ <code>timeout</code> æ˜¯æ­£æ•´æ•°ï¼Œé‚£ä¹ˆé˜»å¡ç›´åˆ°è¿™ä¸ªæ—¶é—´ï¼Œå°±ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚</li>
<li>å¦‚æœ <code>block</code> ä¸º <code>False</code> ï¼Œå¦‚æœé˜Ÿåˆ—æœ‰é—²ç½®é‚£ä¹ˆä¼šç«‹å³æ’å…¥ï¼Œå¦åˆ™å°±ç«‹å³æŠ›å‡ºå¼‚å¸¸ï¼ˆ <code>timeout</code> å°†ä¼šè¢«å¿½ç•¥ï¼‰ã€‚æœ¬ä¾‹ä¸­ï¼Œ <code>put()</code> æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦å·²æ»¡ï¼Œç„¶åè°ƒç”¨ <code>wait()</code> å¼€å§‹ç­‰å¾…ã€‚</li>
</ul>
<p>æ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­å–å‡ºæ•´æ•°ç„¶åç”¨ <code>task_done()</code> æ–¹æ³•å°†å…¶æ ‡ä¸ºä»»åŠ¡å·²å¤„ç†ã€‚</p>
<p>æ¶ˆè´¹è€…ä½¿ç”¨ <code>Queue.get([block[, timeout]])</code> ä»é˜Ÿåˆ—ä¸­å–å›æ•°æ®ï¼Œqueueå†…éƒ¨ä¹Ÿä¼šç»è¿‡é”çš„å¤„ç†ã€‚å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œæ¶ˆè´¹è€…é˜»å¡ã€‚</p>
<p>æœ€åï¼Œåœ¨ä¸»ç¨‹åºä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºçº¿ç¨‹tä½œä¸ºç”Ÿäº§è€…ï¼Œt1, t2, t3ä½œä¸ºæ¶ˆè´¹è€…ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">if __name__ == &#39;__main__&#39;:    queue = Queue()    t1 = producer(queue)    t2 = consumer(queue)    t3 = consumer(queue)    t4 = consumer(queue)    t1.start()    t2.start()    t3.start()    t4.start()    t1.join()    t2.join()    t3.join()    t4.join()
</code></pre></td></tr></table>
</div>
</div><p>ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„æ“ä½œå¯ä»¥ç”¨ä¸‹å›¾æ¥æè¿°ï¼š</p>
<p>




<img loading="lazy" decoding="async"
         src="https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/queue.png"
         alt="../_images/queue.png"
         title="queue.png"
    /></p>
<h2 id="13-è¯„ä¼°å¤šçº¿ç¨‹åº”ç”¨çš„æ€§èƒ½">13. è¯„ä¼°å¤šçº¿ç¨‹åº”ç”¨çš„æ€§èƒ½</h2>
<p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†éªŒè¯GILçš„å½±å“ï¼Œè¯„ä¼°å¤šçº¿ç¨‹åº”ç”¨çš„æ€§èƒ½ã€‚å‰æ–‡å·²ç»ä»‹ç»è¿‡ï¼ŒGILæ˜¯CPythonè§£é‡Šå™¨å¼•å…¥çš„é”ï¼ŒGILåœ¨è§£é‡Šå™¨å±‚é¢é˜»æ­¢äº†çœŸæ­£çš„å¹¶è¡Œè¿è¡Œã€‚è§£é‡Šå™¨åœ¨æ‰§è¡Œä»»ä½•çº¿ç¨‹ä¹‹å‰ï¼Œå¿…é¡»ç­‰å¾…å½“å‰æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹é‡Šæ”¾GILã€‚äº‹å®ä¸Šï¼Œè§£é‡Šå™¨ä¼šå¼ºè¿«æƒ³è¦è¿è¡Œçš„çº¿ç¨‹å¿…é¡»æ‹¿åˆ°GILæ‰èƒ½è®¿é—®è§£é‡Šå™¨çš„ä»»ä½•èµ„æºï¼Œä¾‹å¦‚æ ˆæˆ–Pythonå¯¹è±¡ç­‰ã€‚è¿™ä¹Ÿæ­£æ˜¯GILçš„ç›®çš„â€”â€”é˜»æ­¢ä¸åŒçš„çº¿ç¨‹å¹¶å‘è®¿é—®Pythonå¯¹è±¡ã€‚è¿™æ ·GILå¯ä»¥ä¿æŠ¤è§£é‡Šå™¨çš„å†…å­˜ï¼Œè®©åƒåœ¾å›æ”¶å·¥ä½œæ­£å¸¸ã€‚ä½†äº‹å®ä¸Šï¼Œè¿™å´é€ æˆäº†ç¨‹åºå‘˜æ— æ³•é€šè¿‡å¹¶è¡Œæ‰§è¡Œå¤šçº¿ç¨‹æ¥æé«˜ç¨‹åºçš„æ€§èƒ½ã€‚å¦‚æœæˆ‘ä»¬å»æ‰CPythonçš„GILï¼Œå°±å¯ä»¥è®©å¤šçº¿ç¨‹çœŸæ­£å¹¶è¡Œæ‰§è¡Œã€‚GILå¹¶æ²¡æœ‰å½±å“å¤šå¤„ç†å™¨å¹¶è¡Œçš„çº¿ç¨‹ï¼Œåªæ˜¯é™åˆ¶äº†ä¸€ä¸ªè§£é‡Šå™¨åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¿è¡Œã€‚</p>
<h3 id="131-ä»£ç ">13.1 ä»£ç </h3>
<p>ä¸‹é¢çš„ä»£ç æ˜¯ç”¨æ¥è¯„ä¼°å¤šçº¿ç¨‹åº”ç”¨æ€§èƒ½çš„ç®€å•å·¥å…·ã€‚ä¸‹é¢çš„æ¯ä¸€ä¸ªæµ‹è¯•éƒ½å¾ªç¯è°ƒç”¨å‡½æ•°100æ¬¡ï¼Œé‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œå–é€Ÿåº¦æœ€å¿«çš„ä¸€æ¬¡ã€‚åœ¨ <code>for</code> å¾ªç¯ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨ <code>non_threaded</code> å’Œ <code>threaded</code> å‡½æ•°ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¼šä¸æ–­å¢åŠ è°ƒç”¨æ¬¡æ•°å’Œçº¿ç¨‹æ•°æ¥é‡å¤æ‰§è¡Œè¿™ä¸ªæµ‹è¯•ã€‚æˆ‘ä»¬ä¼šå°è¯•ä½¿ç”¨1ï¼Œ2ï¼Œ3ï¼Œ4å’Œ8çº¿ç¨‹æ•°æ¥è°ƒç”¨çº¿ç¨‹ã€‚åœ¨éçº¿ç¨‹çš„æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬é¡ºåºè°ƒç”¨å‡½æ•°ä¸å¯¹åº”çº¿ç¨‹æ•°ä¸€æ ·å¤šçš„æ¬¡æ•°ã€‚ä¸ºäº†ä¿æŒç®€å•ï¼Œåº¦é‡çš„æŒ‡æ ‡ä½¿ç”¨Pythonçš„å†…å»ºæ¨¡å—timerã€‚</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Threadclass</span> <span class="n">threads_object</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="n">function_to_run</span><span class="p">()</span><span class="k">class</span> <span class="nc">nothreads_object</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="n">function_to_run</span><span class="p">()</span><span class="k">def</span> <span class="nf">non_threaded</span><span class="p">(</span><span class="n">num_iter</span><span class="p">):</span>    <span class="n">funcs</span> <span class="o">=</span> <span class="p">[]</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">num_iter</span><span class="p">)):</span>        <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nothreads_object</span><span class="p">())</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>        <span class="n">i</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="k">def</span> <span class="nf">threaded</span><span class="p">(</span><span class="n">num_threads</span><span class="p">):</span>    <span class="n">funcs</span> <span class="o">=</span> <span class="p">[]</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">num_threads</span><span class="p">)):</span>        <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">threads_object</span><span class="p">())</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>        <span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>        <span class="n">i</span><span class="o">.</span><span class="n">join</span><span class="p">()</span><span class="k">def</span> <span class="nf">function_to_run</span><span class="p">():</span>    <span class="n">passdef</span> <span class="n">show_results</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%-23s</span><span class="s2"> </span><span class="si">%4.6f</span><span class="s2"> seconds&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">results</span><span class="p">))</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>    <span class="kn">import</span> <span class="nn">sys</span>    <span class="nn">from</span> <span class="nn">timeit</span> <span class="nn">import</span> <span class="nn">Timer</span>    <span class="nn">repeat</span> <span class="o">=</span> <span class="mi">100</span>    <span class="n">number</span> <span class="o">=</span> <span class="mi">1</span>    <span class="n">num_threads</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Starting tests&#39;</span><span class="p">)</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">num_threads</span><span class="p">:</span>        <span class="n">t</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="s2">&#34;non_threaded(</span><span class="si">%s</span><span class="s2">)&#34;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&#34;from __main__ import non_threaded&#34;</span><span class="p">)</span>        <span class="n">best_result</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">repeat</span><span class="o">=</span><span class="n">repeat</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">))</span>        <span class="n">show_results</span><span class="p">(</span><span class="s2">&#34;non_threaded (</span><span class="si">%s</span><span class="s2"> iters)&#34;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">best_result</span><span class="p">)</span>        <span class="n">t</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="s2">&#34;threaded(</span><span class="si">%s</span><span class="s2">)&#34;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&#34;from __main__ import threaded&#34;</span><span class="p">)</span>        <span class="n">best_result</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">repeat</span><span class="o">=</span><span class="n">repeat</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">))</span>        <span class="n">show_results</span><span class="p">(</span><span class="s2">&#34;threaded (</span><span class="si">%s</span><span class="s2"> threads)&#34;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">best_result</span><span class="p">)</span>        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Iterations complete&#39;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="132-è§£é‡Š">13.2. è§£é‡Š</h2>
<p>æˆ‘ä»¬ä¸€å…±è¿›è¡Œäº†å››æ¬¡æµ‹è¯•(è¯‘è€…æ³¨ï¼šåŸæ–‡æ˜¯threeï¼Œæˆ‘æ€€ç–‘åŸä½œè€…ä¸è¯†æ•°ï¼ŒåŸæ–‡çš„3ä¸ªçº¿ç¨‹æ•°ä¹Ÿæ²¡æœ‰å†™åœ¨ä»£ç é‡Œï¼‰ï¼Œæ¯ä¸€æ¬¡éƒ½ä¼šä½¿ç”¨ä¸åŒçš„functionè¿›è¡Œæµ‹è¯•ï¼Œåªè¦æ”¹å˜ <code>function_to_run()</code> å°±å¯ä»¥äº†ã€‚</p>
<p>æµ‹è¯•ç”¨çš„æœºå™¨æ˜¯ Core 2 Duo CPU â€“ 2.33Ghzã€‚</p>
<h3 id="ç¬¬ä¸€æ¬¡æµ‹è¯•">ç¬¬ä¸€æ¬¡æµ‹è¯•</h3>
<p>åœ¨ç¬¬ä¸€æ¬¡æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªç®€å•çš„ç©ºå‡½æ•°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">def function_to_run():    pass
</code></pre></td></tr></table>
</div>
</div><p>ä¸‹å›¾å±•ç¤ºäº†æˆ‘ä»¬æµ‹è¯•çš„æ¯ä¸ªæœºåˆ¶çš„è¿è¡Œé€Ÿåº¦ï¼š</p>
<p>




<img loading="lazy" decoding="async"
         src="https://typora-1300715298.cos.ap-shanghai.myqcloud.com/uPic/image-20210624105756890.png"
         alt="test1"
         title="image-20210624105756890.png"
    /></p>
<p>é€šè¿‡ç»“æœå¯ä»¥å‘ç°ï¼Œä½¿ç”¨çº¿ç¨‹çš„å¼€é”€è¦æ¯”ä¸ä½¿ç”¨çº¿ç¨‹çš„å¼€é”€å¤§çš„å¤šã€‚ç‰¹åˆ«çš„ï¼Œæˆ‘ä»¬å‘ç°éšç€çº¿ç¨‹çš„æ•°é‡å¢åŠ ï¼Œå¸¦æ¥çš„å¼€é”€æ˜¯æˆæ¯”ä¾‹çš„ã€‚4ä¸ªçº¿ç¨‹çš„è¿è¡Œæ—¶é—´æ˜¯0.000162ç§’ï¼Œ8ä¸ªçº¿ç¨‹çš„è¿è¡Œæ—¶é—´æ˜¯0.000316ç§’ã€‚</p>
<h3 id="ç¬¬äºŒæ¬¡æµ‹è¯•">ç¬¬äºŒæ¬¡æµ‹è¯•</h3>
<p>å¤šçº¿ç¨‹æ¯”è¾ƒå¸¸ç”¨çš„ä¸€ä¸ªç”¨é€”æ˜¯å¤„ç†æ•°å­—ï¼Œä¸‹é¢çš„æµ‹è¯•è®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼Œæ³¨æ„è¿™ä¸ªä¾‹å­ä¸­æ²¡æœ‰å…±äº«çš„èµ„æºï¼Œåªæ˜¯æµ‹è¯•ç”Ÿæˆæ•°å­—æ•°åˆ—ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">def function_to_run():    a, b = 0, 1    for i in range(10000):        a, b = b, a + b
</code></pre></td></tr></table>
</div>
</div><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<p>




<img loading="lazy" decoding="async"
         src="https://typora-1300715298.cos.ap-shanghai.myqcloud.com/uPic/image-20210624105829147.png"
         alt="image-20210624105829147"
         title="image-20210624105829147.png"
    /></p>
<p>åœ¨è¾“å‡ºä¸­å¯ä»¥çœ‹åˆ°ï¼Œæé«˜çº¿ç¨‹çš„æ•°é‡å¹¶æ²¡æœ‰å¸¦æ¥æ”¶ç›Šã€‚å› ä¸ºGILå’Œçº¿ç¨‹ç®¡ç†ä»£ç çš„å¼€é”€ï¼Œå¤šçº¿ç¨‹è¿è¡Œæ°¸è¿œä¸å¯èƒ½æ¯”å‡½æ•°é¡ºåºæ‰§è¡Œæ›´å¿«ã€‚å†æ¬¡æé†’ä¸€ä¸‹ï¼šGILåªå…è®¸è§£é‡Šå™¨ä¸€æ¬¡æ‰§è¡Œä¸€ä¸ªçº¿ç¨‹ã€‚</p>
<h3 id="ç¬¬ä¸‰æ¬¡æµ‹è¯•">ç¬¬ä¸‰æ¬¡æµ‹è¯•</h3>
<p>ä¸‹é¢çš„æµ‹è¯•æ˜¯è¯»1kbçš„æ•°æ®1000æ¬¡ï¼Œæµ‹è¯•ç”¨çš„å‡½æ•°å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">def function_to_run():    fh=open(&#34;C:\\CookBookFileExamples\\test.dat&#34;,&#34;rb&#34;)    size = 1024    for i in range(1000):        fh.read(size)
</code></pre></td></tr></table>
</div>
</div><p>æµ‹è¯•çš„ç»“æœå¦‚ä¸‹ï¼š</p>
<p>




<img loading="lazy" decoding="async"
         src="https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/Page-92-Image-18.png"
         alt="../_images/Page-92-Image-18.png"
         title="Page-92-Image-18.png"
    /></p>
<p>æˆ‘ä»¬ç»ˆäºçœ‹åˆ°å¤šçº¿ç¨‹æ¯”éå¤šçº¿ç¨‹è·‘çš„å¥½çš„æƒ…å†µäº†ï¼Œè€Œä¸”å¤šçº¿ç¨‹åªç”¨äº†ä¸€åŠçš„æ—¶é—´ã€‚è¿™ç»™æˆ‘ä»¬çš„å¯ç¤ºæ˜¯ï¼Œå¤šçº¿ç¨‹å¹¶ä¸æ˜¯ä¸€ä¸ªæ ‡å‡†ã€‚ä¸€èˆ¬ï¼Œæˆ‘ä»¬å°†ä¼šå°†å¤šçº¿ç¨‹æ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œå°†å®ƒä»¬æ”¾åˆ°ä¸€è¾¹ï¼Œæ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚ä½¿ç”¨å¤šçº¿ç¨‹æ‰§è¡ŒåŒä¸€ä¸ªç›¸åŒçš„ä»»åŠ¡æœ‰æ—¶å€™å¾ˆæœ‰ç”¨ï¼Œä½†ç”¨åˆ°çš„æ—¶å€™å¾ˆå°‘ï¼Œé™¤ééœ€è¦å¤§é‡å¤„ç†æ•°æ®è¾“å…¥ã€‚</p>
<h3 id="ç¬¬å››æ¬¡æµ‹è¯•">ç¬¬å››æ¬¡æµ‹è¯•</h3>
<p>åœ¨æœ€åçš„æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>urllib.request</code> æµ‹è¯•ï¼Œè¿™æ˜¯ä¸€ä¸ªPythonæ¨¡å—ï¼Œå¯ä»¥å‘é€URLè¯·æ±‚ã€‚æ­¤æ¨¡å—åŸºäº <code>socket</code> ï¼Œä½¿ç”¨Cè¯­è¨€ç¼–å†™å¹¶ä¸”æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç å°è¯•è¯»å– <code>https://www.packpub.com</code> çš„ä¸»é¡µå¹¶ä¸”è¯»å–å‰1kçš„æ•°æ®ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">def function_to_run():    import urllib.request    for i in range(10):        with urllib.request.urlopen(&#34;https://www.packtpub.com/&#34;)as f:            f.read(1024)
</code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<p>




<img loading="lazy" decoding="async"
         src="https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/Page-93-Image-19.png"
         alt="../_images/Page-93-Image-19.png"
         title="Page-93-Image-19.png"
    /></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ I/O æœŸé—´ï¼ŒGILé‡Šæ”¾äº†ã€‚å¤šçº¿ç¨‹æ‰§è¡Œæ¯”å•çº¿ç¨‹å¿«çš„å¤šã€‚é‰´äºå¤§å¤šæ•°åº”ç”¨éœ€è¦å¾ˆå¤šI/Oæ“ä½œï¼ŒGILå¹¶æ²¡æœ‰é™åˆ¶ç¨‹åºå‘˜åœ¨è¿™æ–¹é¢ä½¿ç”¨å¤šçº¿ç¨‹å¯¹ç¨‹åºè¿›è¡Œæ€§èƒ½ä¼˜åŒ–ã€‚</p>
<h2 id="133-äº†è§£æ›´å¤š">13.3. äº†è§£æ›´å¤š</h2>
<p>ä½ åº”è¯¥è®°ä½ï¼Œå¢åŠ çº¿ç¨‹å¹¶ä¸ä¼šæé«˜åº”ç”¨å¯åŠ¨çš„æ—¶é—´ï¼Œä½†æ˜¯å¯ä»¥æ”¯æŒå¹¶å‘ã€‚ä¾‹å¦‚ï¼Œä¸€æ¬¡æ€§åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå¹¶é‡ç”¨workerä¼šå¾ˆæœ‰ç”¨ã€‚è¿™å¯ä»¥è®©æˆ‘ä»¬åˆ‡åˆ†ä¸€ä¸ªå¤§çš„æ•°æ®é›†ï¼Œç”¨åŒæ ·çš„å‡½æ•°å¤„ç†ä¸åŒçš„éƒ¨åˆ†ï¼ˆç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼‰ã€‚ä¸Šé¢è¿™äº›æµ‹è¯•å¹¶ä¸æ˜¯å¹¶å‘åº”ç”¨çš„æ¨¡å‹ï¼Œåªæ˜¯å°½é‡ç®€å•çš„æµ‹è¯•ã€‚é‚£ä¹ˆGILä¼šæˆä¸ºè¯•å›¾å‘æŒ¥å¤šçº¿ç¨‹åº”ç”¨æ½œèƒ½çš„çº¯Pythonå¼€å‘çš„ç“¶é¢ˆå—ï¼Ÿæ˜¯çš„ã€‚çº¿ç¨‹æ˜¯ç¼–ç¨‹è¯­è¨€çš„æ¶æ„ï¼ŒCPythonè§£é‡Šå™¨æ˜¯çº¿ç¨‹å’Œæ“ä½œç³»ç»Ÿçš„æ¡¥æ¢ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆJythonï¼ŒIronPythonæ²¡æœ‰GILçš„åŸå› ï¼ˆè¯‘è€…æ³¨ï¼šPypyä¹Ÿæ²¡æœ‰ï¼‰ï¼Œå› ä¸ºå®ƒä¸æ˜¯å¿…è¦çš„ã€‚</p>
</div>

            <div class="post" style="padding-top: 0">


<div class="post-share"><div class="share-link">
        <a class="share-icon share-facebook" href="javascript:void(0);" title="åˆ†äº«åˆ° Facebook" data-sharer="facebook" data-url="http://www.longtermbook.com/posts/%E5%9F%BA%E4%BA%8E%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%B9%B6%E8%A1%8C/" data-hashtag="pythoné«˜æ€§èƒ½ç¼–ç¨‹"><span class="svg-social-icon icon-facebook"></span></a>
    </div><div class="share-link">
        <a class="share-icon share-whatsapp" href="javascript:void(0);" title="åˆ†äº«åˆ° WhatsApp" data-sharer="whatsapp" data-url="http://www.longtermbook.com/posts/%E5%9F%BA%E4%BA%8E%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%B9%B6%E8%A1%8C/" data-title="åŸºäºçº¿ç¨‹çš„å¹¶è¡Œ" data-web><span class="svg-social-icon icon-whatsapp"></span></a>
    </div><div class="share-link">
        <a class="share-icon share-line" href="javascript:void(0);" title="åˆ†äº«åˆ° Line" data-sharer="line" data-url="http://www.longtermbook.com/posts/%E5%9F%BA%E4%BA%8E%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%B9%B6%E8%A1%8C/" data-title="åŸºäºçº¿ç¨‹çš„å¹¶è¡Œ"><span data-svg-src="/lib/simple-icons/icons/line.min.svg"></span></a>
</div><div class="share-link">
        <a class="share-icon share-evernote" href="javascript:void(0);" title="åˆ†äº«åˆ° Evernote" data-sharer="evernote" data-url="http://www.longtermbook.com/posts/%E5%9F%BA%E4%BA%8E%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%B9%B6%E8%A1%8C/" data-title="åŸºäºçº¿ç¨‹çš„å¹¶è¡Œ"><span class="svg-social-icon icon-evernote"></span></a>
    </div></div>
<div class="post-tags"><a href="/tags/python%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/" class="tag">pythoné«˜æ€§èƒ½ç¼–ç¨‹</a></div></div>
        </div>
    <div id="toc-final"></div>
    </article></div>

</main><footer class="footer">
        <div class="footer-container"><div class="footer-line">ç”± <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.82.0">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href="https://ublogger.netlify.app/?utm_source=http://www.longtermbook.com/&utm_medium=footer&utm_campaign=config&utm_term=2.0.1" target="_blank" title="uBlogger 2.0.1">uBlogger</a>
                </div><div class="footer-line"><i class="svg-icon icon-copyright"></i><span>2018 - 2022</span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="å›åˆ°é¡¶éƒ¨">
                <i class="svg-icon icon-arrow-up"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="æŸ¥çœ‹è¯„è®º">
                <i class="svg-icon icon-comments-fixed"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script src="/lib/autocomplete/autocomplete.min.js"></script><script src="/lib/lunr/lunr.min.js"></script><script src="/lib/lunr/lunr.stemmer.support.min.js"></script><script src="/lib/lunr/lunr.zh.min.js"></script><script src="/lib/clipboard/clipboard.min.js"></script><script src="/lib/sharer/sharer.min.js"></script><script src="/lib/katex/katex.min.js"></script><script src="/lib/katex/auto-render.min.js"></script><script src="/lib/katex/copy-tex.min.js"></script><script src="/lib/katex/mhchem.min.js"></script><script>window.config={"code":{"copyTitle":"å¤åˆ¶åˆ°å‰ªè´´æ¿","maxShownLines":20},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"æ²¡æœ‰æ‰¾åˆ°ç»“æœ","snippetLength":30,"type":"lunr"}};</script><script src="/js/theme.min.js"></script></body>
</html>
