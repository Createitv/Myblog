<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1"><meta name="robots" content="noodp"/><title>异步编程 | 且慢</title><meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content=""/>
<meta name="twitter:title" content="异步编程"/>
<meta name="twitter:description" content="Createitv"/><meta name="Description" content="Createitv"><meta property="og:title" content="异步编程" />
<meta property="og:description" content="Createitv" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://www.longtermbook.com/posts/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/" /><meta property="og:image" content="http://www.longtermbook.com/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-27T11:08:19&#43;08:00" />
<meta property="article:modified_time" content="2021-07-27T11:08:19&#43;08:00" /><meta property="og:site_name" content="且慢" />

<meta name="application-name" content="Createitv">
<meta name="apple-mobile-web-app-title" content="Createitv"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
        <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
        <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://www.longtermbook.com/posts/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "异步编程",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/www.longtermbook.com\/posts\/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B\/"
        },"genre": "posts","keywords": "python高性能编程","wordCount":  3797 ,
        "url": "http:\/\/www.longtermbook.com\/posts\/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B\/","datePublished": "2021-07-27T11:08:19+08:00","dateModified": "2021-07-27T11:08:19+08:00","description": "Createitv"
    }
    </script><script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [{
            "@type": "ListItem",
            "position": 1,
            "name": "主页",
            "item": "http:\/\/www.longtermbook.com\/"
        },{
            "@type": "ListItem",
            "position": 2,
            "name": "python",
            "item": "http://www.longtermbook.com/categories/python/"
        },{
                "@type": "ListItem",
                "position": 3,
                "name": "异步编程"
            }]
    }
</script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="且慢" class="header-logo logo-svg">且慢</a>
        </div>
        <div class="menu">
            <nav>
                <ul class="menu-inner"><li>
                        <a class="menu-item" href="/posts/"> 文章 </a>
                    </li><li>
                        <a class="menu-item" href="/tags/"> 标签 </a>
                    </li><li>
                        <a class="menu-item" href="/categories/"> 分类 </a>
                    </li></ul>
            </nav><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <span class="svg-icon icon-search"></span>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <span class="svg-icon icon-cancel"></span>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <span class="svg-icon icon-loading"></span>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <span class="svg-icon icon-moon"></span>
                </a>
            </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="且慢" class="header-logo">且慢</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <span class="svg-icon icon-search"></span>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <span class="svg-icon icon-cancel"></span>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <span class="svg-icon icon-loading"></span>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><nav>
                <ul><li>
                        <a class="menu-item" href="/posts/" title="">文章</a>
                    </li><li>
                        <a class="menu-item" href="/tags/" title="">标签</a>
                    </li><li>
                        <a class="menu-item" href="/categories/" title="">分类</a>
                    </li></ul>
            </nav>
            <a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <span class="svg-icon icon-moon"></span>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div><main class="main">
<div class="container content-article  theme-classic"><div class="toc" id="toc-auto">
            <div class="toc-title">目录</div>
            <div class="toc-content" id="toc-content-auto"></div>
        </div>

    <div class="header-post">

        

        
        <div class="post-title">

                <div class="post-all-meta">
                    <nav class="breadcrumbs">
    <ol>
        <li><a href="/">主页 </a></li><li><a href="/categories/python/">python </a></li><li>异步编程</li>
    </ol>
</nav>
                    <h1 class="single-title flipInX">异步编程</h1><div class="post-meta">
                        <div class="post-meta-line"><span class="post-category">
                                <a href="/categories/python/"><i class="svg-icon icon-folder"></i>python</a>
                            </span><span class="post-meta-date">
                                <i class="svg-icon icon-clock"></i><time class="timeago" datetime="2021-07-27">2021-07-27</time>
                            </span><span class="post-meta-words">
                                <i class="svg-icon icon-pencil"></i>约 3797 字
                            </span>
                            <span class="post-meta-reading">
                                <i class="svg-icon icon-stopwatch"></i>预计阅读 8 分钟
                            </span>
                        </div>
                    </div>
                </div>

            </div>

            </div>

    <article class="single toc-start">

        <div class="content-block content-block-first content-block-position">

        <div class="post"><div class="details toc" id="toc-static"  data-kept="true">
                <div class="details-summary toc-title">
                    <span>目录</span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-异步编程介绍">1. 异步编程介绍</a></li>
    <li><a href="#2-使用python的-concurrentfutures-模块">2. 使用Python的 <code>concurrent.futures</code> 模块</a>
      <ul>
        <li><a href="#21-使用线程池和进程池">2.1. 使用线程池和进程池</a></li>
        <li><a href="#22-准备工作">2.2. 准备工作</a></li>
        <li><a href="#23-代码">2.3. 代码</a></li>
        <li><a href="#24-代码解释">2.4 代码解释</a></li>
      </ul>
    </li>
    <li><a href="#3-使用asyncio管理事件循环">3. 使用Asyncio管理事件循环</a>
      <ul>
        <li><a href="#31-什么是事件循环">3.1. 什么是事件循环</a></li>
        <li><a href="#32-准备工作">3.2. 准备工作</a></li>
        <li><a href="#33-代码">3.3. 代码</a></li>
      </ul>
    </li>
    <li><a href="#34-代码解释">3.4. 代码解释</a></li>
    <li><a href="#4-使用asyncio控制任务">4. 使用Asyncio控制任务</a>
      <ul>
        <li><a href="#41-准备工作">4.1. 准备工作</a></li>
        <li><a href="#42-如何做">4.2. 如何做…</a></li>
        <li><a href="#43-代码解释">4.3. 代码解释</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><h2 id="1-异步编程介绍">1. 异步编程介绍</h2>
<p>除了顺序执行和并行执行的模型之外，还有第三种模型，叫做异步模型，这是事件驱动模型的基础。异步活动的执行模型可以只有一个单一的主控制流，能在单核心系统和多核心系统中运行。</p>
<p>在并发执行的异步模型中，许多任务被穿插在同一时间线上，所有的任务都由一个控制流执行（单一线程）。任务的执行可能被暂停或恢复，中间的这段时间线程将会去执行其他任务。下面的这幅图可以清楚地表达这个概念。</p>
<p>




<img loading="lazy" decoding="async"
         src="https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/asynchronous-programming-model.png"
         alt="../_images/asynchronous-programming-model.png"
         title="asynchronous-programming-model.png"
    /></p>
<p>如上图所示，任务（不同的颜色表示不同的任务）可能被其他任务插入，但是都处在同一个线程下。这表明，当某一个任务执行的时候，其他的任务都暂停了。与多线程编程模型很大的一点不同是， <em>多线程由操作系统决定在时间线上什么时候挂起某个活动或恢复某个活动，而在异步并发模型中，程序员必须假设线程可能在任何时间被挂起和替换。</em></p>
<p>程序员可以将任务编写成许多可以间隔执行的小步骤， <em>这样的话如果一个任务需要另一个任务的输出，那么被依赖的任务必须接收它的输入。</em></p>
<h2 id="2-使用python的-concurrentfutures-模块">2. 使用Python的 <code>concurrent.futures</code> 模块</h2>
<p>Python3.2带来了 <code>concurrent.futures</code> 模块，这个模块具有线程池和进程池、管理并行编程任务、处理非确定性的执行流程、进程/线程同步等功能。</p>
<p>此模块由以下部分组成：</p>
<ul>
<li><code>concurrent.futures.Executor</code>: 这是一个虚拟基类，提供了异步执行的方法。</li>
<li><code>submit(function, argument)</code>: 调度函数（可调用的对象）的执行，将 <code>argument</code> 作为参数传入。</li>
<li><code>map(function, argument)</code>: 将 <code>argument</code> 作为参数执行函数，以 <strong>异步</strong> 的方式。</li>
<li><code>shutdown(Wait=True)</code>: 发出让执行者释放所有资源的信号。</li>
<li><code>concurrent.futures.Future</code>: 其中包括函数的异步执行。Future对象是submit任务（即带有参数的functions）到executor的实例。</li>
</ul>
<p>Executor是抽象类，可以通过子类访问，即线程或进程的 <code>ExecutorPools</code> 。因为，线程或进程的实例是依赖于资源的任务，所以最好以“池”的形式将他们组织在一起，作为可以重用的launcher或executor。</p>
<h3 id="21-使用线程池和进程池">2.1. 使用线程池和进程池</h3>
<p>线程池或进程池是用于在程序中优化和简化线程/进程的使用。通过池，你可以提交任务给executor。池由两部分组成，一部分是内部的队列，存放着待执行的任务；另一部分是一系列的进程或线程，用于执行这些任务。池的概念主要目的是为了重用：让线程或进程在生命周期内可以多次使用。它减少了创建创建线程和进程的开销，提高了程序性能。重用不是必须的规则，但它是程序员在应用中使用池的主要原因。</p>
<p>




<img loading="lazy" decoding="async"
         src="https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/pooling-management.png"
         alt="../_images/pooling-management.png"
         title="pooling-management.png"
    /></p>
<h3 id="22-准备工作">2.2. 准备工作</h3>
<p><code>current.Futures</code> 模块提供了两种 <code>Executor</code> 的子类，各自独立操作一个线程池和一个进程池。这两个子类分别是：</p>
<ul>
<li><code>concurrent.futures.ThreadPoolExecutor(max_workers)</code></li>
<li><code>concurrent.futures.ProcessPoolExecutor(max_workers)</code></li>
</ul>
<p><code>max_workers</code> 参数表示最多有多少个worker并行执行任务。</p>
<h3 id="23-代码">2.3. 代码</h3>
<p>下面的示例代码展示了线程池和进程池的功能。这里的任务是，给一个list <code>number_list</code> ，包含1到10。对list中的每一个数字，乘以1+2+3…+10000000的和（这个任务只是为了消耗时间）。</p>
<p>下面的代码分别测试了：</p>
<ul>
<li>顺序执行</li>
<li>通过有5个worker的线程池执行</li>
<li>通过有5个worker的进程池执行</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">concurrent.futures</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="n">number_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">evaluate_item</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="c1"># 计算总和，这里只是为了消耗时间</span>
        <span class="n">result_item</span> <span class="o">=</span> <span class="n">count</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># 打印输入和输出结果</span>
        <span class="k">return</span> <span class="n">result_item</span>

<span class="k">def</span>  <span class="nf">count</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10000000</span><span class="p">):</span>
                <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">i</span> <span class="o">*</span> <span class="n">number</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
        <span class="c1"># 顺序执行</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">number_list</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">evaluate_item</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Sequential execution in &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">),</span> <span class="s2">&#34;seconds&#34;</span><span class="p">)</span>
        <span class="c1"># 线程池执行</span>
        <span class="n">start_time_1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">evaluate_item</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">number_list</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
                        <span class="k">print</span><span class="p">(</span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
        <span class="k">print</span> <span class="p">(</span><span class="s2">&#34;Thread pool execution in &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time_1</span><span class="p">),</span> <span class="s2">&#34;seconds&#34;</span><span class="p">)</span>
        <span class="c1"># 进程池</span>
        <span class="n">start_time_2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">evaluate_item</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">number_list</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
                        <span class="k">print</span><span class="p">(</span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
        <span class="k">print</span> <span class="p">(</span><span class="s2">&#34;Process pool execution in &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time_2</span><span class="p">),</span> <span class="s2">&#34;seconds&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>运行结果</p>
<p>




<img loading="lazy" decoding="async"
         src="https://typora-1300715298.cos.ap-shanghai.myqcloud.com/uPic/image-20210625084504658.png"
         alt="运行结果"
         title="image-20210625084504658.png"
    /></p>
<h3 id="24-代码解释">2.4 代码解释</h3>
<p>我们创建了一个list存放10个数字，然后使用一个循环计算从1加到10000000，打印出和与 <code>number_list</code> 的乘积。:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">evaluate_item</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="c1"># 计算总和，这里只是为了消耗时间</span>
    <span class="n">result_item</span> <span class="o">=</span> <span class="n">count</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="c1"># 打印输入和输出结果</span>
    <span class="k">print</span> <span class="p">(</span><span class="s2">&#34;item &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34; result &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">result_item</span><span class="p">))</span>

<span class="k">def</span>  <span class="nf">count</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10000000</span><span class="p">):</span>
        <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">i</span> <span class="o">*</span> <span class="n">number</span>
</code></pre></td></tr></table>
</div>
</div><p>在主要程序中，我们先使用顺序执行跑了一次程序：:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="c1"># 顺序执行</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">number_list</span><span class="p">:</span>
        <span class="n">evaluate_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Sequential execution in &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">),</span> <span class="s2">&#34;seconds&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>然后，我们使用了 <code>futures.ThreadPoolExecutor</code> 模块的线程池跑了一次：:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">number_list</span><span class="p">:</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">evaluate_item</span><span class="p">,</span>  <span class="n">item</span><span class="p">)</span>
<span class="k">print</span> <span class="p">(</span><span class="s2">&#34;Thread pool execution in &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time_1</span><span class="p">),</span> <span class="s2">&#34;seconds&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p><code>ThreadPoolExecutor</code> 使用线程池中的一个线程执行给定的任务。池中一共有5个线程，每一个线程从池中取得一个任务然后执行它。当任务执行完成，再从池中拿到另一个任务。</p>
<p>当所有的任务执行完成后，打印出执行用的时间：:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">print</span> <span class="p">(</span><span class="s2">&#34;Thread pool execution in &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time_1</span><span class="p">),</span> <span class="s2">&#34;seconds&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>最后，我们又用 <code>ProcessPoolExecutor</code> 跑了一次程序：:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">number_list</span><span class="p">:</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">evaluate_item</span><span class="p">,</span>  <span class="n">item</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>如同 <code>ThreadPoolExecutor</code> 一样， <code>ProcessPoolExecutor</code> 是一个executor，使用一个线程池来并行执行任务。然而，和 <code>ThreadPoolExecutor</code> 不同的是， <code>ProcessPoolExecutor</code> 使用了多核处理的模块，让我们可以不受GIL的限制，大大缩短执行时间。</p>
<h2 id="3-使用asyncio管理事件循环">3. 使用Asyncio管理事件循环</h2>
<p>Python的Asyncio模块提供了管理事件、协程、任务和线程的方法，以及编写并发代码的原语。此模块的主要组件和概念包括：</p>
<ul>
<li><strong>事件循环</strong>: 在Asyncio模块中，每一个进程都有一个事件循环。</li>
<li><strong>协程</strong>: 这是子程序的泛化概念。协程可以在执行期间暂停，这样就可以等待外部的处理（例如IO）完成之后，从之前暂停的地方恢复执行。</li>
<li><strong>Futures</strong>: 定义了 <code>Future</code> 对象，和 <code>concurrent.futures</code> 模块一样，表示尚未完成的计算。</li>
<li><strong>Tasks</strong>: 这是Asyncio的子类，用于封装和管理并行模式下的协程。</li>
</ul>
<p>本节中重点讨论事件，事实上，异步编程的上下文中，事件无比重要。因为事件的本质就是异步。</p>
<h3 id="31-什么是事件循环">3.1. 什么是事件循环</h3>
<p>在计算系统中，可以产生事件的实体叫做事件源，能处理事件的实体叫做事件处理者。此外，还有一些第三方实体叫做事件循环。它的作用是管理所有的事件，在整个程序运行过程中不断循环执行，追踪事件发生的顺序将它们放到队列中，当主线程空闲的时候，调用相应的事件处理者处理事件。最后，我们可以通过下面的伪代码来理解事件循环：:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">events</span> <span class="o">=</span> <span class="n">getEvents</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">e</span> <span class="ow">in</span> <span class="n">events</span><span class="p">)</span>
        <span class="n">processEvent</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>所有的事件都在 <code>while</code> 循环中捕捉，然后经过事件处理者处理。事件处理的部分是系统唯一活跃的部分，当一个事件处理完成，流程继续处理下一个事件。</p>
<h3 id="32-准备工作">3.2. 准备工作</h3>
<p>Asyncio提供了一下方法来管理事件循环：</p>
<ul>
<li><code>loop = get_event_loop()</code>: 得到当前上下文的事件循环。</li>
<li><code>loop.call_later(time_delay, callback, argument)</code>: 延后 <code>time_delay</code> 秒再执行 <code>callback</code> 方法。</li>
<li><code>loop.call_soon(callback, argument)</code>: 尽可能快调用 <code>callback</code>, <code>call_soon()</code> 函数结束，主线程回到事件循环之后就会马上调用 <code>callback</code> 。</li>
<li><code>loop.time()</code>: 以float类型返回当前时间循环的内部时间。</li>
<li><code>asyncio.set_event_loop()</code>: 为当前上下文设置事件循环。</li>
<li><code>asyncio.new_event_loop()</code>: 根据此策略创建一个新的时间循环并返回。</li>
<li><code>loop.run_forever()</code>: 在调用 <code>stop()</code> 之前将一直运行。</li>
</ul>
<h3 id="33-代码">3.3. 代码</h3>
<p>下面的代码中，我们将展示如何使用Asyncio库提供的时间循环创建异步模式的应用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">function_1</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">loop</span><span class="p">):</span>
    <span class="k">print</span> <span class="p">(</span><span class="s2">&#34;function_1 called&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">end_time</span><span class="p">:</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">call_later</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">function_2</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">function_2</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">loop</span><span class="p">):</span>
    <span class="k">print</span> <span class="p">(</span><span class="s2">&#34;function_2 called &#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">end_time</span><span class="p">:</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">call_later</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">function_3</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">function_3</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">loop</span><span class="p">):</span>
    <span class="k">print</span> <span class="p">(</span><span class="s2">&#34;function_3 called&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">end_time</span><span class="p">:</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">call_later</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">function_1</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">function_4</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">loop</span><span class="p">):</span>
    <span class="k">print</span> <span class="p">(</span><span class="s2">&#34;function_5 called&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">end_time</span><span class="p">:</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">call_later</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">function_4</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>

<span class="n">end_loop</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mf">9.0</span>
<span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="n">function_1</span><span class="p">,</span> <span class="n">end_loop</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span>
<span class="c1"># loop.call_soon(function_4, end_loop, loop)</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>运行结果如下：:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">python3</span> <span class="n">event</span><span class="o">.</span><span class="n">pyfunction_1</span> <span class="n">calledfunction_2</span> <span class="n">calledfunction_3</span> <span class="n">calledfunction_1</span> <span class="n">calledfunction_2</span> <span class="n">calledfunction_3</span> <span class="n">calledfunction_1</span> <span class="n">calledfunction_2</span> <span class="n">calledfunction_3</span> <span class="n">called</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="34-代码解释">3.4. 代码解释</h2>
<p>在这个例子中，我们定义了三个异步的任务，相继执行，入下图所示的顺序。</p>
<p>




<img loading="lazy" decoding="async"
         src="https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/task-execution.png"
         alt="../_images/task-execution.png"
         title="task-execution.png"
    /></p>
<p>首先，我们要得到这个事件循环：:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>然后我们通过 <code>call_soon</code> 方法调用了 <code>function_1()</code> 函数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">end_loop</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mf">9.0</span><span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="n">function_1</span><span class="p">,</span> <span class="n">end_loop</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>让我们来看一下 <code>function_1()</code> 的定义：:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">function_1</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">loop</span><span class="p">):</span>    <span class="k">print</span> <span class="p">(</span><span class="s2">&#34;function_1 called&#34;</span><span class="p">)</span>    <span class="k">if</span> <span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">end_time</span><span class="p">:</span>        <span class="n">loop</span><span class="o">.</span><span class="n">call_later</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">function_2</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span>    <span class="k">else</span><span class="p">:</span>        <span class="n">loop</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>这个函数通过以下参数定义了应用的异步行为：</p>
<ul>
<li><code>end_time</code>: 定义了 <code>function_1()</code> 可以运行的最长时间，并通过 <code>call_later</code> 方法传入到 <code>function_2()</code> 中作为参数</li>
<li><code>loop</code>: 之前通过 <code>get_event_loop()</code> 方法得到的事件循环</li>
</ul>
<p><code>function_1()</code> 的任务非常简单，只是打印出函数名字。当然，里面也可以写非常复杂的操作。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">print</span> <span class="p">(</span><span class="s2">&#34;function_1 called&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>任务执行结束之后，它将会比较 <code>loop.time()</code> +1s和设定的运行时间，如果没有超过，使用 <code>call_later</code> 在1秒之后执行 <code>function_2()</code> 。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">if</span> <span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">end_time</span><span class="p">:</span>    <span class="n">loop</span><span class="o">.</span><span class="n">call_later</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">function_2</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span><span class="k">else</span><span class="p">:</span>    <span class="n">loop</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p><code>function_2()</code> 和 <code>function_3()</code> 的作用类似。</p>
<p>如果运行的时间超过了设定，时间循环终止。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span><span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="4-使用asyncio控制任务">4. 使用Asyncio控制任务</h2>
<p>Asyncio是用来处理事件循环中的异步进程和并发任务执行的。它还提供了 <code>asyncio.Task()</code> 类，可以在任务中使用协程。它的作用是，在同一事件循环中,运行某一个任务的同时可以并发地运行多个任务。当协程被包在任务中，它会自动将任务和事件循环连接起来，当事件循环启动的时候，任务自动运行。这样就提供了一个可以自动驱动协程的机制。</p>
<h3 id="41-准备工作">4.1. 准备工作</h3>
<p>Asyncio模块为我们提供了 <code>asyncio.Task(coroutine)</code> 方法来处理计算任务，它可以调度协程的执行。任务对协程对象在事件循环的执行负责。如果被包裹的协程要从future yield，那么任务会被挂起，等待future的计算结果。</p>
<p>当future计算完成，被包裹的协程将会拿到future返回的结果或异常（exception）继续执行。另外，需要注意的是，事件循环一次只能运行一个任务，除非还有其它事件循环在不同的线程并行运行，此任务才有可能和其他任务并行。当一个任务在等待future执行的期间，事件循环会运行一个新的任务。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">&#34;&#34;&#34;Asyncio using Asyncio.Task to execute three math function in parallel&#34;&#34;&#34;import asyncio@asyncio.coroutinedef factorial(number):    f = 1    for i in range(2, number + 1):        print(&#34;Asyncio.Task: Compute factorial(%s)&#34; % (i))        yield from asyncio.sleep(1)        f *= i    print(&#34;Asyncio.Task - factorial(%s) = %s&#34; % (number, f))@asyncio.coroutinedef fibonacci(number):    a, b = 0, 1    for i in range(number):        print(&#34;Asyncio.Task: Compute fibonacci (%s)&#34; % (i))        yield from asyncio.sleep(1)        a, b = b, a + b    print(&#34;Asyncio.Task - fibonacci(%s) = %s&#34; % (number, a))@asyncio.coroutinedef binomialCoeff(n, k):    result = 1    for i in range(1, k+1):        result = result * (n-i+1) / i        print(&#34;Asyncio.Task: Compute binomialCoeff (%s)&#34; % (i))        yield from asyncio.sleep(1)    print(&#34;Asyncio.Task - binomialCoeff(%s , %s) = %s&#34; % (n, k, result))if __name__ == &#34;__main__&#34;:    tasks = [asyncio.Task(factorial(10)),             asyncio.Task(fibonacci(10)),             asyncio.Task(binomialCoeff(20, 10))]    loop = asyncio.get_event_loop()    loop.run_until_complete(asyncio.wait(tasks))    loop.close()
</code></pre></td></tr></table>
</div>
</div><h3 id="42-如何做">4.2. 如何做…</h3>
<p>在下面的代码中，我们展示了三个可以被 <code>Asyncio.Task()</code> 并发执行的数学函数。</p>
<p>运行的结果如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">python3 task.pyAsyncio.Task: Compute factorial(2)Asyncio.Task: Compute fibonacci (0)Asyncio.Task: Compute binomialCoeff (1)Asyncio.Task: Compute factorial(3)Asyncio.Task: Compute fibonacci (1)Asyncio.Task: Compute binomialCoeff (2)Asyncio.Task: Compute factorial(4)Asyncio.Task: Compute fibonacci (2)Asyncio.Task: Compute binomialCoeff (3)Asyncio.Task: Compute factorial(5)Asyncio.Task: Compute fibonacci (3)Asyncio.Task: Compute binomialCoeff (4)Asyncio.Task: Compute factorial(6)Asyncio.Task: Compute fibonacci (4)Asyncio.Task: Compute binomialCoeff (5)Asyncio.Task: Compute factorial(7)Asyncio.Task: Compute fibonacci (5)Asyncio.Task: Compute binomialCoeff (6)Asyncio.Task: Compute factorial(8)Asyncio.Task: Compute fibonacci (6)Asyncio.Task: Compute binomialCoeff (7)Asyncio.Task: Compute factorial(9)Asyncio.Task: Compute fibonacci (7)Asyncio.Task: Compute binomialCoeff (8)Asyncio.Task: Compute factorial(10)Asyncio.Task: Compute fibonacci (8)Asyncio.Task: Compute binomialCoeff (9)Asyncio.Task - factorial(10) = 3628800Asyncio.Task: Compute fibonacci (9)Asyncio.Task: Compute binomialCoeff (10)Asyncio.Task - fibonacci(10) = 55Asyncio.Task - binomialCoeff(20 , 10) = 184756.0
</code></pre></td></tr></table>
</div>
</div><h3 id="43-代码解释">4.3. 代码解释</h3>
<p>在这个例子中，我们定义了三个协程， <code>factorial</code>, <code>fibonacci</code> 和 <code>binomialCoeff</code> ，每一个都带有 <code>asyncio.coroutine</code> 装饰器：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">@asyncio.coroutinedef factorial(number):    do Something@asyncio.coroutinedef fibonacci(number):    do Something@asyncio.coroutinedef binomialCoeff(n, k):    do Something
</code></pre></td></tr></table>
</div>
</div><p>为了能并行执行这三个任务，我们将其放到一个task的list中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
<span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span><span class="n">factorial</span><span class="p">(</span><span class="mi">10</span><span class="p">)),</span>  
					<span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span><span class="n">fibonacci</span><span class="p">(</span><span class="mi">10</span><span class="p">)),</span> 
         <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span><span class="n">binomialCoeff</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))]</span>
</code></pre></td></tr></table>
</div>
</div><p>得到事件循环：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">loop = asyncio.get_event_loop()
</code></pre></td></tr></table>
</div>
</div><p>然后运行任务：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">loop.run_until_complete(asyncio.wait(tasks))
</code></pre></td></tr></table>
</div>
</div><p>这里， <code>asyncio.wait(tasks)</code> 表示运行直到所有给定的协程都完成。</p>
<p>最后，关闭事件循环：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">loop.close()
</code></pre></td></tr></table>
</div>
</div></div>

            <div class="post" style="padding-top: 0">


<div class="post-share"><div class="share-link">
        <a class="share-icon share-facebook" href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="http://www.longtermbook.com/posts/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/" data-hashtag="python高性能编程"><span class="svg-social-icon icon-facebook"></span></a>
    </div><div class="share-link">
        <a class="share-icon share-whatsapp" href="javascript:void(0);" title="分享到 WhatsApp" data-sharer="whatsapp" data-url="http://www.longtermbook.com/posts/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/" data-title="异步编程" data-web><span class="svg-social-icon icon-whatsapp"></span></a>
    </div><div class="share-link">
        <a class="share-icon share-line" href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="http://www.longtermbook.com/posts/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/" data-title="异步编程"><span data-svg-src="/lib/simple-icons/icons/line.min.svg"></span></a>
</div><div class="share-link">
        <a class="share-icon share-evernote" href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="http://www.longtermbook.com/posts/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/" data-title="异步编程"><span class="svg-social-icon icon-evernote"></span></a>
    </div></div>
<div class="post-tags"><a href="/tags/python%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/" class="tag">python高性能编程</a></div></div>
        </div>
    <div id="toc-final"></div>
    </article></div>

</main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.82.0">Hugo</a> 强力驱动 | 主题 - <a href="https://ublogger.netlify.app/?utm_source=http://www.longtermbook.com/&utm_medium=footer&utm_campaign=config&utm_term=2.0.1" target="_blank" title="uBlogger 2.0.1">uBlogger</a>
                </div><div class="footer-line"><i class="svg-icon icon-copyright"></i><span>2018 - 2021</span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="svg-icon icon-arrow-up"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="svg-icon icon-comments-fixed"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script src="/lib/autocomplete/autocomplete.min.js"></script><script src="/lib/lunr/lunr.min.js"></script><script src="/lib/lunr/lunr.stemmer.support.min.js"></script><script src="/lib/lunr/lunr.zh.min.js"></script><script src="/lib/clipboard/clipboard.min.js"></script><script src="/lib/sharer/sharer.min.js"></script><script src="/lib/katex/katex.min.js"></script><script src="/lib/katex/auto-render.min.js"></script><script src="/lib/katex/copy-tex.min.js"></script><script src="/lib/katex/mhchem.min.js"></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":20},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":30,"type":"lunr"}};</script><script src="/js/theme.min.js"></script></body>
</html>
